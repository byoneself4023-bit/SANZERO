{% extends "base.html" %}

{% block title %}AI íŒë¡€ ê²€ìƒ‰ ê²°ê³¼ - SANZERO{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <a href="/" class="text-gray-500 hover:text-gray-700 mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰ ê²°ê³¼</h1>
                <div class="ml-4 px-3 py-1 bg-blue-100 text-blue-700 text-sm font-medium rounded-full">
                    ğŸš€ ë™ì  ì„ê³„ê°’ ì ìš©
                </div>
            </div>
            <div class="text-sm text-gray-500">
                {% if analysis and analysis.id %}
                    ìš”ì²­ ID: {{ analysis.id[:8] }}...
                {% else %}
                    ìš”ì²­ ID: ì²˜ë¦¬ ì¤‘...
                {% endif %}
            </div>
        </div>

        <!-- ìƒíƒœ í‘œì‹œ -->
        <div class="flex items-center space-x-4">
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if analysis and analysis.status == 'completed' %}bg-green-100 text-green-800
                {% elif analysis and analysis.status == 'processing' %}bg-yellow-100 text-yellow-800
                {% elif analysis and analysis.status == 'failed' %}bg-red-100 text-red-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if analysis and analysis.status == 'completed' %}âœ… ê²€ìƒ‰ ì™„ë£Œ
                {% elif analysis and analysis.status == 'processing' %}â³ ê²€ìƒ‰ ì§„í–‰ì¤‘
                {% elif analysis and analysis.status == 'failed' %}âŒ ê²€ìƒ‰ ì‹¤íŒ¨
                {% elif processing %}â³ AI ë¶„ì„ ì¤‘...
                {% elif error %}âŒ ë¶„ì„ ì˜¤ë¥˜
                {% else %}â¸ï¸ ê²€ìƒ‰ ëŒ€ê¸°{% endif %}
            </span>
            {% if analysis and analysis.processing_time_ms %}
            <span class="text-sm text-gray-600">
                ì²˜ë¦¬ ì‹œê°„: {{ "%.1f"|format(analysis.processing_time_ms / 1000) }}ì´ˆ
            </span>
            {% endif %}
        </div>
    </div>

    <!-- ì—ëŸ¬ í‘œì‹œ -->
    {% if error %}
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-8">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-red-700">{{ error }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ì²˜ë¦¬ ì¤‘ í‘œì‹œ -->
    {% if processing %}
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">AIê°€ íŒë¡€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                <script>
                    setTimeout(function() { window.location.reload(); }, 5000);
                </script>
            </div>
        </div>
    </div>
    {% endif %}

    {% if analysis and analysis.status == 'completed' %}
    <!-- FastSearchPipeline ê²°ê³¼ëŠ” ì´ë¯¸ ì •ê·œí™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì§ì ‘ ì‚¬ìš© -->

    <!-- ğŸ¯ 1ë‹¨ê³„: ê²€ìƒ‰ ê²°ê³¼ ê°œìš” (ì´ë¯¸ì§€ 1 ìŠ¤íƒ€ì¼) -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
            <svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            ê²€ìƒ‰ ê²°ê³¼
        </h2>

        <!-- í•µì‹¬ í†µê³„ (4ê°œ ì¹´ë“œ) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <!-- ì´ íŒë¡€ ìˆ˜ -->
            <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
                <div class="text-3xl font-bold text-blue-600 mb-2">
                    {{ analysis.precedent_list|length if analysis.precedent_list else 0 }}ê±´
                </div>
                <div class="text-sm text-blue-700 font-medium">ë°œê²¬ëœ ìœ ì‚¬ íŒë¡€</div>
            </div>

            <!-- ìœ ë¶ˆë¦¬ ë¶„í¬ -->
            {% if analysis.precedent_list %}
            {% set favorable_count = analysis.precedent_list|selectattr("worker_favorable", "equalto", "ìœ ë¦¬ O")|list|length %}
            {% set unfavorable_count = analysis.precedent_list|selectattr("worker_favorable", "equalto", "ë¶ˆë¦¬ X")|list|length %}
            {% set neutral_count = analysis.precedent_list|selectattr("worker_favorable", "equalto", "ì• ë§¤ â–³")|list|length %}
            {% else %}
            {% set favorable_count = 0 %}
            {% set unfavorable_count = 0 %}
            {% set neutral_count = 0 %}
            {% endif %}
            {% set total_analyzed = favorable_count + unfavorable_count + neutral_count %}
            {% set favorable_ratio = (favorable_count / total_analyzed * 100)|round(0) if total_analyzed > 0 else 0 %}

            <div class="text-center p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border border-green-200">
                <div class="text-3xl font-bold text-green-600 mb-2">
                    {{ favorable_ratio|int }}%
                </div>
                <div class="text-sm text-green-700 font-medium">ìœ ë¦¬ íŒë¡€</div>
                <div class="text-xs text-green-600 mt-1">
                    {{ favorable_count }}/{{ total_analyzed }}ê±´
                </div>
            </div>

            <!-- ë™ì  ì„ê³„ê°’ -->
            <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
                <div class="text-3xl font-bold text-purple-600 mb-2">
                    {% if analysis.dynamic_threshold and analysis.dynamic_threshold.get('dynamic_threshold') %}
                        {{ "%.1f"|format(analysis.dynamic_threshold.get('dynamic_threshold', 0.5) * 100) }}%
                    {% elif analysis.dynamic_threshold and analysis.dynamic_threshold.get('final_threshold') %}
                        {{ "%.1f"|format(analysis.dynamic_threshold.final_threshold * 100) }}%
                    {% else %}
                        50.0%
                    {% endif %}
                </div>
                <div class="text-sm text-purple-700 font-medium">AI ìµœì  ì„ê³„ê°’</div>
                <div class="text-xs text-purple-600 mt-1">ë™ì  ê³„ì‚°ë¨</div>
            </div>

            <!-- ì‹ ë¢°ë„ ì ìˆ˜ -->
            <div class="text-center p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg border border-orange-200">
                <div class="text-3xl font-bold text-orange-600 mb-2">
                    {{ "%.0f"|format((analysis.confidence_score or 0.5) * 100) }}%
                </div>
                <div class="text-sm text-orange-700 font-medium">ì¢…í•© ì‹ ë¢°ë„</div>
                <div class="text-xs text-orange-600 mt-1">AI í‰ê°€</div>
            </div>
        </div>

        <!-- ğŸ¯ ë™ì  ì„ê³„ê°’ íˆ¬ëª…ì„± ì •ë³´ -->
        {% if analysis.dynamic_threshold %}
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                AI ì„ê³„ê°’ ê³„ì‚° ê³¼ì •
            </h3>

            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <!-- ê¸°ë³¸ ì„ê³„ê°’ -->
                <div class="bg-white rounded-lg p-4 border">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2">ğŸ“Š ê¸°ë³¸ ì„ê³„ê°’</h4>
                    <div class="text-xl font-bold text-gray-600">
                        {{ "%.1f"|format(analysis.dynamic_threshold.get('base_threshold', 0.5) * 100) }}%
                    </div>
                    <p class="text-xs text-gray-600 mt-1">ì‹œì‘ ê¸°ì¤€ì </p>
                </div>

                <!-- ì´ ì¡°ì •ê°’ -->
                <div class="bg-white rounded-lg p-4 border">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2">âš™ï¸ AI ì¡°ì •</h4>
                    {% set final_threshold = analysis.dynamic_threshold.get('final_threshold') or analysis.dynamic_threshold.get('dynamic_threshold', 0.5) %}
                    {% set base_threshold = analysis.dynamic_threshold.get('base_threshold', 0.5) %}
                    {% set total_adjustment = (final_threshold - base_threshold) * 100 %}
                    <div class="text-xl font-bold {% if total_adjustment > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ "{:+.1f}".format(total_adjustment) }}%
                    </div>
                    <p class="text-xs text-gray-600 mt-1">ìë™ ì¡°ì •ê°’</p>
                </div>

                <!-- ìµœì¢… ì„ê³„ê°’ -->
                <div class="bg-white rounded-lg p-4 border border-indigo-200">
                    <h4 class="text-sm font-semibold text-indigo-800 mb-2">ğŸ¯ ìµœì¢… ì ìš©</h4>
                    <div class="text-xl font-bold text-indigo-600">
                        {{ "%.1f"|format(final_threshold * 100) }}%
                    </div>
                    <p class="text-xs text-indigo-600 mt-1">ìµœì í™” ì™„ë£Œ</p>
                </div>
            </div>

            <!-- ì¡°ì • ê·¼ê±° -->
            {% if analysis.dynamic_threshold and analysis.dynamic_threshold.get('reasoning') and analysis.dynamic_threshold.reasoning.get('threshold_explanation') %}
            <div class="bg-indigo-50 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-indigo-800 mb-2">ğŸ’¡ AI íŒë‹¨ ê·¼ê±°</h4>
                <p class="text-sm text-indigo-700">{{ analysis.dynamic_threshold.reasoning.threshold_explanation }}</p>
            </div>
            {% elif analysis.dynamic_threshold and analysis.dynamic_threshold.get('threshold_explanation') %}
            <div class="bg-indigo-50 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-indigo-800 mb-2">ğŸ’¡ AI íŒë‹¨ ê·¼ê±°</h4>
                <p class="text-sm text-indigo-700">{{ analysis.dynamic_threshold.threshold_explanation }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- ğŸ¯ íŒë¡€ ëª©ë¡ (ì¹´ë“œ í˜•íƒœ) -->
        {% if analysis.tfidf_results %}
        <div>
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ğŸ“š ìœ ì‚¬ íŒë¡€ ëª©ë¡ ({{ analysis.tfidf_results|length }}ê±´)
            </h3>

            <div class="grid gap-4">
                {% for precedent in analysis.tfidf_results %}
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <!-- ìˆœìœ„ -->
                                <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2 py-1 rounded">
                                    #{{ loop.index }}
                                </span>

                                <!-- ìœ ë¶ˆë¦¬ ë°°ì§€ -->
                                <span class="text-sm font-medium px-2 py-1 rounded
                                    {% if precedent.get('worker_favorable', '') == 'ìœ ë¦¬ O' %}bg-green-100 text-green-800
                                    {% elif precedent.get('worker_favorable', '') == 'ë¶ˆë¦¬ X' %}bg-red-100 text-red-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ precedent.get('worker_favorable', '') }}
                                </span>

                                <!-- ë§¤ì¹­ í‚¤ì›Œë“œ -->
                                {% if precedent.get('match_keywords', '') and precedent.get('match_keywords', '') != '-' %}
                                <div class="flex flex-wrap gap-1">
                                    {% for keyword in precedent.get('match_keywords', '').split(',')[:3] %}
                                    <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                        {{ keyword.strip() }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <h4 class="font-bold text-gray-900 mb-1">{{ precedent.get('title', '') }}</h4>
                            <p class="text-sm text-gray-600 mb-2">{{ precedent.get('court', '') }} | {{ precedent.get('date', '') }}</p>
                        </div>

                        <!-- ìœ ì‚¬ë„ í‘œì‹œ -->
                        <div class="text-right ml-4">
                            <div class="text-lg font-bold text-blue-600">
                                {{ precedent.get('similarity_pct', 0) }}%
                            </div>
                            <div class="text-xs text-gray-500">ìœ ì‚¬ë„</div>
                        </div>
                    </div>

                    <!-- íŒë¡€ ìš”ì•½ -->
                    <p class="text-sm text-gray-700 mb-3 leading-relaxed">
                        {{ precedent.get('content', '')[:200] }}{% if precedent.get('content', '')|length > 200 %}...{% endif %}
                    </p>

                    <!-- ìƒì„¸ ë¶„ì„ ë²„íŠ¼ -->
                    <div class="flex justify-end">
                        <button onclick="showDetailedAnalysis({{ loop.index0 }})"
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            ìƒì„¸ ë¶„ì„
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ğŸ¯ 2ë‹¨ê³„: ìƒì„¸ ë¶„ì„ ê²°ê³¼ (ì´ë¯¸ì§€ 2 ìŠ¤íƒ€ì¼) -->
    {% if analysis.tfidf_results %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
            <svg class="w-6 h-6 mr-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5h2a2 2 0 012 2v6a2 2 0 01-2 2h-2a2 2 0 01-2-2V7a2 2 0 012-2z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
            </svg>
            ìƒì„¸ ë¶„ì„ (ìƒìœ„ 3ê±´)
        </h2>

        <div class="space-y-8">
            {% for precedent in analysis.tfidf_results[:3] %}
            <div id="detail-{{ loop.index0 }}" class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                <!-- í—¤ë” -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <span class="bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full">
                                ìƒì„¸ ë¶„ì„ #{{ loop.index }}
                            </span>
                            <span class="bg-gray-100 text-gray-700 text-sm px-2 py-1 rounded">
                                {{ precedent.get('category', '') }}
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-purple-600">{{ precedent.get('similarity_pct', 0) }}%</div>
                            <div class="text-xs text-gray-500">ê´€ë ¨ë„</div>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-900 mb-2">{{ precedent.get('title', '') }}</h3>
                    <p class="text-sm text-gray-600 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-6m-2-2h6m-6 2h2m-2 0v-2m0 2h-2m2 0h2m-6 0h6m-2-2h2m2 2h2"></path>
                        </svg>
                        {{ precedent.get('court', '') }} | {{ precedent.get('date', '') }}
                    </p>
                </div>

                <!-- ë¶„ì„ ê·¸ë¦¬ë“œ -->
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- ì™¼ìª½: ì‚¬ì‹¤ê´€ê³„ ë° ìŸì  -->
                    <div class="space-y-6">
                        <!-- ì‚¬ì‹¤ê´€ê³„ -->
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                ğŸ“ ì‚¬ì‹¤ê´€ê³„
                            </h4>
                            <div class="bg-white rounded-lg p-4 border">
                                <p class="text-sm text-gray-700 leading-relaxed">
                                    {{ precedent.get('content', '')[:400] }}{% if precedent.get('content', '')|length > 400 %}...{% endif %}
                                </p>
                            </div>
                        </div>

                        <!-- ë§¤ì¹­ í‚¤ì›Œë“œ -->
                        {% if precedent.get('match_keywords', '') and precedent.get('match_keywords', '') != '-' %}
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                ğŸ·ï¸ ë§¤ì¹­ í‚¤ì›Œë“œ
                            </h4>
                            <div class="flex flex-wrap gap-2">
                                {% for keyword in precedent.get('match_keywords', '').split(',') %}
                                <span class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">
                                    {{ keyword.strip() }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: ë²•ì  ë¶„ì„ -->
                    <div class="space-y-6">
                        <!-- ìœ ë¶ˆë¦¬ ë¶„ì„ -->
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                âš–ï¸ ê·¼ë¡œì ìœ ë¶ˆë¦¬ ë¶„ì„
                            </h4>
                            <div class="bg-white rounded-lg p-4 border">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-900">íŒë‹¨ ê²°ê³¼</span>
                                    <span class="font-bold text-lg
                                        {% if precedent.get('worker_favorable', '') == 'ìœ ë¦¬ O' %}text-green-600
                                        {% elif precedent.get('worker_favorable', '') == 'ë¶ˆë¦¬ X' %}text-red-600
                                        {% else %}text-yellow-600{% endif %}">
                                        {{ precedent.get('worker_favorable', '') }}
                                    </span>
                                </div>

                                <!-- ì ìˆ˜ ì„¸ë¶€ ì •ë³´ -->
                                {% if precedent.get('favorability_score') %}
                                <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
                                    <div class="bg-green-50 rounded p-2">
                                        <div class="font-medium text-green-800">ìœ ë¦¬ ìš”ì†Œ</div>
                                        <div class="text-green-600">{{ precedent.get('favorability_score', {}).get('favorable', 0) }}ì </div>
                                    </div>
                                    <div class="bg-red-50 rounded p-2">
                                        <div class="font-medium text-red-800">ë¶ˆë¦¬ ìš”ì†Œ</div>
                                        <div class="text-red-600">{{ precedent.get('favorability_score', {}).get('unfavorable', 0) }}ì </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ì°¸ê³  ì •ë³´ -->
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ğŸ’¡ ì°¸ê³  ì •ë³´
                            </h4>
                            <div class="bg-white rounded-lg p-4 border space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ì‚¬ê±´ ID:</span>
                                    <span class="text-gray-900 font-mono">{{ precedent.get('case_id', '') }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ì‚¬ê±´ ë¶„ë¥˜:</span>
                                    <span class="text-gray-900">{{ precedent.get('category', '') }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ìœ ì‚¬ë„ ì ìˆ˜:</span>
                                    <span class="text-gray-900">{{ "%.4f"|format(precedent.get('similarity', 0)) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì‹œì‚¬ì  -->
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        ğŸ’¡ ì‹œì‚¬ì 
                    </h4>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-gray-800 leading-relaxed">
                            ë³¸ íŒë¡€ëŠ” <strong>{{ precedent.get('similarity_pct', 0) }}%ì˜ ìœ ì‚¬ë„</strong>ë¥¼ ë³´ì´ë©°,
                            <strong>ê·¼ë¡œìì—ê²Œ {{ precedent.get('worker_favorable', '') }}</strong> ê²°ê³¼ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
                            {% if precedent.get('match_keywords', '') and precedent.get('match_keywords', '') != '-' %}
                            ì£¼ìš” ë§¤ì¹­ í‚¤ì›Œë“œì¸ <em>{{ precedent.get('match_keywords', '').split(',')[0].strip() }}</em> ë“±ì´
                            í˜„ì¬ ì‚¬ê±´ê³¼ ë†’ì€ ê´€ë ¨ì„±ì„ ë³´ì´ë¯€ë¡œ ì°¸ê³ í•  ê°€ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤.
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ê²€ìƒ‰ ê¶Œê³ ì‚¬í•­ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ğŸ¯ AI ì¢…í•© ë¶„ì„ ê²°ê³¼
        </h3>
        <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-gray-800 leading-relaxed">
                {{ analysis.recommendation if analysis.recommendation else "ë™ì  ì„ê³„ê°’ì„ ì ìš©í•œ ê³ ê¸‰ ê²€ìƒ‰ì„ í†µí•´ ì •í™•í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŒë¡€ ê²°ê³¼ë¥¼ ì œê³µí–ˆìŠµë‹ˆë‹¤." }}
            </p>
        </div>
    </div>

    <!-- ì›ë³¸ ì§ˆì˜ ì •ë³´ -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“‹ ê²€ìƒ‰ ì§ˆì˜ ì •ë³´</h3>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h4 class="font-semibold text-gray-900 mb-2">ì›ë³¸ ì§ˆì˜</h4>
                <p class="text-sm text-gray-700 leading-relaxed bg-gray-50 p-4 rounded">{{ analysis.query_text }}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900 mb-2">ê²€ìƒ‰ ì •ë³´</h4>
                <div class="space-y-2 text-sm bg-gray-50 p-4 rounded">
                    <div class="flex justify-between">
                        <span class="text-gray-600">ê²€ìƒ‰ ì‹œê°„:</span>
                        <span class="text-gray-900">
                            {% if analysis.created_at %}{{ analysis.created_at[:16] }}{% else %}-{% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ì²˜ë¦¬ ì‹œê°„:</span>
                        <span class="text-gray-900">{{ "%.1f"|format((analysis.processing_time_ms or 0) / 1000) }}ì´ˆ</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ê²€ìƒ‰ ë°©ì‹:</span>
                        <span class="text-gray-900">ë™ì  ì„ê³„ê°’ + AI ë¶„ì„</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t">
                        <span class="text-gray-600">ìœ ë¦¬ íŒë¡€:</span>
                        <span class="text-gray-900 font-medium text-green-600">{{ favorable_count }}ê±´</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ë¶ˆë¦¬ íŒë¡€:</span>
                        <span class="text-gray-900 font-medium text-red-600">{{ unfavorable_count }}ê±´</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ì¤‘ë¦½ íŒë¡€:</span>
                        <span class="text-gray-900 font-medium text-yellow-600">{{ neutral_count }}ê±´</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì‹¤íŒ¨ ìƒíƒœ -->
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <h3 class="text-lg font-medium text-gray-900 mb-2">
            {% if analysis.status == 'processing' %}ê²€ìƒ‰ ì§„í–‰ì¤‘{% elif analysis.status == 'failed' %}ê²€ìƒ‰ ì‹¤íŒ¨{% else %}ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ{% endif %}
        </h3>
        <p class="text-gray-600">
            {% if analysis.status == 'processing' %}íŒë¡€ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
            {% elif analysis.status == 'failed' %}ê²€ìƒ‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            {% else %}ê²€ìƒ‰ì´ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.{% endif %}
        </p>
    </div>
    {% endif %}
</div>

<script>
// ìƒì„¸ ë¶„ì„ í‘œì‹œ í•¨ìˆ˜
function showDetailedAnalysis(index) {
    const detailElement = document.getElementById(`detail-${index}`);
    if (detailElement) {
        detailElement.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        // í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
        detailElement.classList.add('ring-2', 'ring-purple-300', 'ring-opacity-50');
        setTimeout(() => {
            detailElement.classList.remove('ring-2', 'ring-purple-300', 'ring-opacity-50');
        }, 2000);
    }
}

// ì§„í–‰ì¤‘ ìƒíƒœì¼ ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨
{% if analysis.status == 'processing' %}
setTimeout(function() {
    location.reload();
}, 30000); // 30ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
{% endif %}
</script>
{% endblock %}