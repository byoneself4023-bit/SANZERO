{% extends "base.html" %}

{% block title %}ê²€ìƒ‰ ê²°ê³¼ - SANZERO{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <a href="/" class="text-gray-500 hover:text-gray-700 mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰ ê²°ê³¼</h1>
            </div>
            <div class="text-sm text-gray-500">
                ìš”ì²­ ID: {{ analysis.id[:8] }}...
            </div>
        </div>

        <!-- ìƒíƒœ í‘œì‹œ -->
        <div class="flex items-center space-x-4">
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if analysis.status == 'completed' %}bg-green-100 text-green-800
                {% elif analysis.status == 'processing' %}bg-yellow-100 text-yellow-800
                {% elif analysis.status == 'failed' %}bg-red-100 text-red-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if analysis.status == 'completed' %}âœ… ê²€ìƒ‰ ì™„ë£Œ
                {% elif analysis.status == 'processing' %}â³ ê²€ìƒ‰ ì§„í–‰ì¤‘
                {% elif analysis.status == 'failed' %}âŒ ê²€ìƒ‰ ì‹¤íŒ¨
                {% else %}â¸ï¸ ê²€ìƒ‰ ëŒ€ê¸°{% endif %}
            </span>
            {% if analysis.processing_time_ms %}
            <span class="text-sm text-gray-600">
                ì²˜ë¦¬ ì‹œê°„: {{ "%.1f"|format(analysis.processing_time_ms / 1000) }}ì´ˆ
            </span>
            {% endif %}
        </div>
    </div>

    {% if analysis.status == 'processing' %}
    <!-- ì§„í–‰ì¤‘ ìƒíƒœ -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
        <div class="animate-spin w-12 h-12 border-4 border-yellow-200 border-t-yellow-600 rounded-full mx-auto mb-4"></div>
        <h3 class="text-lg font-medium text-yellow-800 mb-2">íŒë¡€ ê²€ìƒ‰ ì§„í–‰ì¤‘</h3>
        <p class="text-yellow-700">
            ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë³´í†µ 2-5ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.
        </p>
        <button onclick="location.reload()" class="mt-4 bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
            ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        </button>
    </div>

    {% elif analysis.status == 'failed' %}
    <!-- ì‹¤íŒ¨ ìƒíƒœ -->
    <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
        <svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-lg font-medium text-red-800 mb-2">ê²€ìƒ‰ ì‹¤íŒ¨</h3>
        <p class="text-red-700 mb-4">
            {% if analysis.error_message %}
                {{ analysis.error_message }}
            {% else %}
                ê²€ìƒ‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            {% endif %}
        </p>
        <a href="/analysis/precedent" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
            ë‹¤ì‹œ ì‹œë„í•˜ê¸°
        </a>
    </div>

    {% elif analysis.status == 'completed' and analysis.result %}
    <!-- ì™„ë£Œ ìƒíƒœ -->
    {% set result = analysis.result %}

    <!-- ê²€ìƒ‰ ìš”ì•½ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">ê²€ìƒ‰ ìš”ì•½</h2>
        <div class="grid md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600">
                    {% if result.search_summary and result.search_summary.total_found %}
                        {{ result.search_summary.total_found }}ê±´
                    {% else %}
                        {{ result.precedent_list|length if result.precedent_list else 0 }}ê±´
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600">ê²€ìƒ‰ëœ ìœ ì‚¬ íŒë¡€</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600">
                    {% if result.search_summary and result.search_summary.confidence_score %}
                        {{ "%.0f"|format(result.search_summary.confidence_score * 100) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600">ì‹ ë¢°ë„</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-purple-600">
                    {% if result.detailed_analysis %}
                        {{ result.detailed_analysis|length }}ê°œ
                    {% else %}
                        0ê°œ
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600">ìƒì„¸ ë¶„ì„</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-orange-600">
                    {% if result.search_summary %}
                        {{ "%.1f"|format(result.search_summary.processing_time) }}ì´ˆ
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600">ê²€ìƒ‰ ì‹œê°„</div>
            </div>
        </div>
    </div>

    <!-- ğŸš€ ê²€ìƒ‰ ì„¤ì • íˆ¬ëª…ì„± ì„¹ì…˜ (ìƒˆë¡œ ì¶”ê°€) -->
    {% if result.search_summary and result.search_summary.threshold_info %}
    {% set threshold_info = result.search_summary.threshold_info %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ê²€ìƒ‰ ì„¤ì • ìƒì„¸ ì •ë³´
        </h2>

        <div class="grid md:grid-cols-3 gap-4 mb-4">
            <!-- ì ìš©ëœ ì„ê³„ê°’ -->
            <div class="bg-orange-50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-orange-800 mb-2">ğŸ“Š ì ìš©ëœ ì„ê³„ê°’</h3>
                <div class="text-2xl font-bold text-orange-600 mb-1">
                    {{ "%.1f"|format(threshold_info.final_threshold * 100) }}%
                </div>
                <p class="text-xs text-orange-700">
                    {{ threshold_info.threshold_explanation if threshold_info.threshold_explanation else "AIê°€ ìµœì í™”í•œ ì„ê³„ê°’" }}
                </p>
            </div>

            <!-- ì‹ ë¢°ë„ ë²”ìœ„ -->
            <div class="bg-green-50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-green-800 mb-2">ğŸ¯ ì‹ ë¢°ë„ ë²”ìœ„</h3>
                <div class="text-2xl font-bold text-green-600 mb-1">
                    {{ threshold_info.confidence_range if threshold_info.confidence_range else "ë³´í†µ" }}
                </div>
                <p class="text-xs text-green-700">
                    ì´ ì„ê³„ê°’ì—ì„œ ì˜ˆìƒë˜ëŠ” ê²°ê³¼ì˜ ì‹ ë¢°ë„ ë²”ìœ„
                </p>
            </div>

            <!-- ì¶”ì²œ ê²°ê³¼ìˆ˜ -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-blue-800 mb-2">ğŸ”¢ ìµœì  ê²°ê³¼ìˆ˜</h3>
                <div class="text-2xl font-bold text-blue-600 mb-1">
                    {{ threshold_info.result_count if threshold_info.result_count else "10" }}ê°œ
                </div>
                <p class="text-xs text-blue-700">
                    ìµœì í™”ëœ íŒë¡€ ê²€ìƒ‰ ìˆ˜ëŸ‰
                </p>
            </div>
        </div>

        <!-- ì„ê³„ê°’ ì¡°ì • ìƒì„¸ ë‚´ì—­ -->
        {% if threshold_info.adjustments %}
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <h3 class="text-sm font-semibold text-gray-800 mb-3">âš™ï¸ AI ìë™ ì¡°ì • ë‚´ì—­</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-700 mb-2">
                        <strong>ê¸°ë³¸ ì„ê³„ê°’:</strong> {{ "%.1f"|format(threshold_info.base_threshold * 100) }}%
                        ({{ threshold_info.accuracy_level }} ìˆ˜ì¤€)
                    </p>
                    {% if threshold_info.total_adjustment != 0 %}
                    <p class="text-sm text-gray-700">
                        <strong>ì´ ì¡°ì •ê°’:</strong>
                        <span class="{% if threshold_info.total_adjustment > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            {{ "{:+.1f}".format(threshold_info.total_adjustment * 100) }}%
                        </span>
                    </p>
                    {% endif %}
                </div>
                <div>
                    {% if threshold_info.adjustments %}
                    <ul class="text-xs text-gray-600 space-y-1">
                        {% for adjustment in threshold_info.adjustments %}
                        <li class="flex items-center">
                            <span class="w-2 h-2 bg-orange-400 rounded-full mr-2"></span>
                            {{ adjustment }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ì„±ëŠ¥ ì •ë³´ -->
        {% if result.search_summary.parallel_performance %}
        {% set perf = result.search_summary.parallel_performance %}
        <div class="bg-purple-50 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-purple-800 mb-3">âš¡ ì„±ëŠ¥ ìµœì í™” ê²°ê³¼</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-lg font-bold text-purple-600">{{ perf.favorability_analysis_time }}ì´ˆ</div>
                    <div class="text-xs text-purple-700">ìœ ë¦¬/ë¶ˆë¦¬ ë¶„ì„</div>
                </div>
                <div>
                    <div class="text-lg font-bold text-purple-600">{{ perf.detailed_analysis_time }}ì´ˆ</div>
                    <div class="text-xs text-purple-700">ìƒì„¸ ë¶„ì„</div>
                </div>
                <div>
                    <div class="text-lg font-bold text-purple-600">{{ perf.total_processing_time }}ì´ˆ</div>
                    <div class="text-xs text-purple-700">ì „ì²´ ì²˜ë¦¬ì‹œê°„</div>
                </div>
                <div class="flex items-center justify-center">
                    <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">
                        ë³‘ë ¬ ì²˜ë¦¬ âš¡
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ğŸš€ ë²•ë¥  ë™ì˜ì–´ í™•ì¥ ì •ë³´ (ìƒˆë¡œ ì¶”ê°€) -->
        {% if result.search_summary.enhanced_preprocessing %}
        {% set preprocessing = result.search_summary.enhanced_preprocessing %}
        <div class="bg-teal-50 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-teal-800 mb-3 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ğŸ” AI ì¿¼ë¦¬ ì „ì²˜ë¦¬ ê²°ê³¼
            </h3>

            <div class="grid md:grid-cols-3 gap-4 mb-3">
                <!-- ì „ì²˜ë¦¬ ê°€ìš©ì„± -->
                <div class="text-center p-2 rounded">
                    <div class="text-sm font-medium {% if preprocessing.available %}text-green-600{% else %}text-gray-600{% endif %}">
                        {% if preprocessing.available %}âœ… ì‚¬ìš© ê°€ëŠ¥{% else %}â¸ï¸ ë¹„í™œì„±í™”{% endif %}
                    </div>
                    <div class="text-xs text-gray-600">ê°•í™”ëœ ì „ì²˜ë¦¬</div>
                </div>

                <!-- ë™ì˜ì–´ í™•ì¥ ì ìš© -->
                <div class="text-center p-2 rounded">
                    <div class="text-sm font-medium {% if preprocessing.applied %}text-green-600{% else %}text-gray-600{% endif %}">
                        {% if preprocessing.applied %}âœ… ì ìš©ë¨{% else %}â– ë¯¸ì ìš©{% endif %}
                    </div>
                    <div class="text-xs text-gray-600">ë²•ë¥  ë™ì˜ì–´ í™•ì¥</div>
                </div>

                <!-- í™•ì¥ëœ ìš©ì–´ ìˆ˜ -->
                <div class="text-center p-2 rounded">
                    <div class="text-sm font-medium text-teal-600">
                        {{ preprocessing.expanded_terms|length if preprocessing.expanded_terms else 0 }}ê°œ
                    </div>
                    <div class="text-xs text-gray-600">ì¶”ê°€ëœ ë™ì˜ì–´</div>
                </div>
            </div>

            <!-- í™•ì¥ëœ ìš©ì–´ í‘œì‹œ -->
            {% if preprocessing.expanded_terms %}
            <div class="mb-3">
                <h4 class="text-xs font-semibold text-teal-700 mb-2">ğŸ”¤ ì¶”ê°€ëœ ë²•ë¥  ë™ì˜ì–´</h4>
                <div class="flex flex-wrap gap-1">
                    {% for term in preprocessing.expanded_terms[:8] %}
                    <span class="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full">
                        {{ term }}
                    </span>
                    {% endfor %}
                    {% if preprocessing.expanded_terms|length > 8 %}
                    <span class="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full">
                        +{{ preprocessing.expanded_terms|length - 8 }}ê°œ ë”
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- ì¿¼ë¦¬ í’ˆì§ˆ ë¶„ì„ (ìˆëŠ” ê²½ìš°) -->
            {% if preprocessing.query_analysis %}
            {% set qa = preprocessing.query_analysis %}
            <div class="grid md:grid-cols-4 gap-3 mb-3 text-center">
                <div class="p-2 bg-white rounded border">
                    <div class="text-sm font-bold text-gray-900">{{ "%.0f"|format(qa.quality_score * 100) }}%</div>
                    <div class="text-xs text-gray-600">ì¿¼ë¦¬ í’ˆì§ˆ</div>
                </div>
                <div class="p-2 bg-white rounded border">
                    <div class="text-sm font-bold text-gray-900">{{ qa.word_count }}ê°œ</div>
                    <div class="text-xs text-gray-600">ì´ ë‹¨ì–´ìˆ˜</div>
                </div>
                <div class="p-2 bg-white rounded border">
                    <div class="text-sm font-bold text-gray-900">{{ qa.legal_keywords }}ê°œ</div>
                    <div class="text-xs text-gray-600">ë²•ë¥  í‚¤ì›Œë“œ</div>
                </div>
                <div class="p-2 bg-white rounded border">
                    <div class="text-sm font-bold text-gray-900">{{ qa.specificity_keywords }}ê°œ</div>
                    <div class="text-xs text-gray-600">êµ¬ì²´ì„± í‚¤ì›Œë“œ</div>
                </div>
            </div>
            {% endif %}

            <!-- ì „ì²˜ë¦¬ ë…¸íŠ¸ -->
            {% if preprocessing.preprocessing_notes %}
            <div class="bg-white rounded border p-3">
                <h4 class="text-xs font-semibold text-gray-700 mb-2">ğŸ“‹ ì „ì²˜ë¦¬ ê³¼ì •</h4>
                <ul class="text-xs text-gray-600 space-y-1">
                    {% for note in preprocessing.preprocessing_notes %}
                    <li class="flex items-start">
                        <span class="w-1.5 h-1.5 bg-teal-400 rounded-full mr-2 mt-1.5 flex-shrink-0"></span>
                        <span>{{ note }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- ìºì‹œ ì •ë³´ (ìºì‹œ íˆíŠ¸ì¸ ê²½ìš°) -->
        {% if result.cache_info and result.cache_info.cache_hit %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-4">
            <div class="flex items-center">
                <svg class="w-4 h-4 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <span class="text-sm text-yellow-800">
                    <strong>ë¹ ë¥¸ ì‘ë‹µ:</strong> ì´ì „ ë¶„ì„ ê²°ê³¼ë¥¼ í™œìš©í•˜ì—¬ 0.1ì´ˆë§Œì— ê²°ê³¼ë¥¼ ì œê³µí–ˆìŠµë‹ˆë‹¤.
                </span>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ë©”ì¸ ê²€ìƒ‰ ê²°ê³¼ -->
    <div class="space-y-6">

            <!-- ê²€ìƒ‰ ê¶Œê³ ì‚¬í•­ -->
            {% if result.search_summary and result.search_summary.recommendation %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ê²€ìƒ‰ ë¶„ì„ ê²°ê³¼</h3>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-gray-800 leading-relaxed">{{ result.search_summary.recommendation }}</p>
                </div>
            </div>
            {% endif %}

            <!-- ğŸš€ RAG ë¶„ì„ ê²°ê³¼ (ìƒˆë¡œ ì¶”ê°€) -->
            {% if result.rag_analysis %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    ğŸ¤– AI ì‹¬í™” ë¶„ì„ (RAG)
                </h3>

                <!-- RAG ë¶„ì„ ìš”ì•½ -->
                {% if result.rag_analysis.summary %}
                <div class="bg-indigo-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-indigo-800 mb-2">ğŸ“ ì¢…í•© ë¶„ì„</h4>
                    <p class="text-gray-800 leading-relaxed">{{ result.rag_analysis.summary }}</p>
                </div>
                {% endif %}

                <!-- RAG í‚¤ì›Œë“œ ë¶„ì„ -->
                {% if result.rag_analysis.key_insights %}
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ì£¼ìš” ë°œê²¬ì‚¬í•­
                        </h4>
                        {% if result.rag_analysis.key_insights %}
                        <ul class="text-sm text-green-700 space-y-1">
                            {% for insight in result.rag_analysis.key_insights %}
                            <li class="flex items-start">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 mt-2 flex-shrink-0"></span>
                                <span>{{ insight }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>

                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.962-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            ì£¼ì˜ì‚¬í•­
                        </h4>
                        {% if result.rag_analysis.warnings or result.rag_analysis.limitations %}
                        <ul class="text-sm text-yellow-700 space-y-1">
                            {% for warning in result.rag_analysis.warnings or [] %}
                            <li class="flex items-start">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2 mt-2 flex-shrink-0"></span>
                                <span>{{ warning }}</span>
                            </li>
                            {% endfor %}
                            {% for limitation in result.rag_analysis.limitations or [] %}
                            <li class="flex items-start">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2 mt-2 flex-shrink-0"></span>
                                <span>{{ limitation }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- RAG ì¶”ì²œì‚¬í•­ -->
                {% if result.rag_analysis.recommendations %}
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        AI ì¶”ì²œì‚¬í•­
                    </h4>
                    <ul class="text-sm text-blue-700 space-y-2">
                        {% for recommendation in result.rag_analysis.recommendations %}
                        <li class="flex items-start">
                            <span class="w-2 h-2 bg-blue-400 rounded-full mr-2 mt-2 flex-shrink-0"></span>
                            <span>{{ recommendation }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- RAG ì‹ ë¢°ë„ ì •ë³´ -->
                {% if result.rag_analysis.confidence_score or result.rag_analysis.data_sources %}
                <div class="grid md:grid-cols-2 gap-4 mt-4">
                    {% if result.rag_analysis.confidence_score %}
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-lg font-bold text-gray-900">
                            {{ "%.0f"|format(result.rag_analysis.confidence_score * 100) }}%
                        </div>
                        <div class="text-xs text-gray-600">AI ë¶„ì„ ì‹ ë¢°ë„</div>
                    </div>
                    {% endif %}
                    {% if result.rag_analysis.data_sources %}
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <div class="text-lg font-bold text-gray-900">
                            {{ result.rag_analysis.data_sources|length }}ê°œ
                        </div>
                        <div class="text-xs text-gray-600">ì°¸ì¡° ë°ì´í„° ì†ŒìŠ¤</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- RAG ë¶„ì„ í•œê³„ ì•ˆë‚´ -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mt-4">
                    <p class="text-xs text-gray-600">
                        <strong>â„¹ï¸ ì°¸ê³ ì‚¬í•­:</strong> AI ì‹¬í™” ë¶„ì„ì€ ëŒ€ëŸ‰ì˜ íŒë¡€ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì°¸ê³ ìš© ì •ë³´ì…ë‹ˆë‹¤.
                        ì‹¤ì œ ë²•ì  íŒë‹¨ì€ ê°œë³„ ì‚¬ê±´ì˜ êµ¬ì²´ì  ì‚¬ì‹¤ê´€ê³„ì™€ ë²•ì  í•´ì„ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
                        ì „ë¬¸ê°€ì™€ì˜ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
            {% else %}
            <!-- RAG ë¶„ì„ì´ ì—†ëŠ” ê²½ìš° ì•Œë¦¼ -->
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-indigo-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm text-indigo-700">
                        <strong>AI ì‹¬í™” ë¶„ì„:</strong> í˜„ì¬ ë²„ì „ì—ì„œëŠ” TF-IDF ê¸°ë°˜ ë¹ ë¥¸ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                        RAG ê¸°ë°˜ ì‹¬í™” ë¶„ì„ ê¸°ëŠ¥ì€ í–¥í›„ ë²„ì „ì—ì„œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.
                    </span>
                </div>
            </div>
            {% endif %}

            <!-- 10ê°œ ìœ ì‚¬ íŒë¡€ ëª©ë¡ -->
            {% if result.precedent_list %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“š ìœ ì‚¬ íŒë¡€ ëª©ë¡ ({{ result.precedent_list|length }}ê±´)</h3>
                <div class="space-y-4">
                    {% for item in result.precedent_list %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2 py-1 rounded">
                                        #{{ item.rank }}
                                    </span>
                                    <!-- ìœ ë¦¬/ë¶ˆë¦¬ íŒë‹¨ ë°°ì§€ -->
                                    {% if item.favorability %}
                                    <span class="text-sm font-medium px-2 py-1 rounded
                                        {% if item.favorability.assessment == 'ìœ ë¦¬' %}bg-green-100 text-green-800
                                        {% elif item.favorability.assessment == 'ë¶ˆë¦¬' %}bg-red-100 text-red-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ item.favorability.assessment }}
                                        ({{ "%.0f"|format(item.favorability.confidence * 100) }}%)
                                    </span>
                                    {% endif %}
                                </div>
                                <h4 class="font-bold text-gray-900 mb-1">{{ item.precedent.title }}</h4>
                                <p class="text-sm text-gray-600 mb-2">{{ item.precedent.court }} | {{ item.precedent.date }}</p>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-sm font-medium text-blue-600">
                                    ìœ ì‚¬ë„: {{ "%.1f"|format(item.precedent.similarity * 100) }}%
                                </div>
                            </div>
                        </div>

                        <p class="text-sm text-gray-700 mb-3">{{ item.precedent.summary }}</p>

                        <!-- ìœ ë¦¬/ë¶ˆë¦¬ ë¶„ì„ ì´ìœ  -->
                        {% if item.favorability and item.favorability.reason %}
                        <div class="bg-gray-50 rounded p-3">
                            <p class="text-sm text-gray-600">
                                <strong>ë¶„ì„ ê·¼ê±°:</strong> {{ item.favorability.reason }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ìƒìœ„ 3ê°œ ì‚¬ë¡€ ìƒì„¸ ë¶„ì„ -->
            {% if result.detailed_analysis %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ” ìƒì„¸ ë¶„ì„ (ìƒìœ„ {{ result.detailed_analysis|length }}ê°œ ì‚¬ë¡€)</h3>
                <div class="space-y-6">
                    {% for detail in result.detailed_analysis %}
                    <div class="border border-gray-200 rounded-lg p-5">
                        <div class="mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-purple-100 text-purple-800 text-sm font-medium px-2 py-1 rounded">
                                    ìƒì„¸ ë¶„ì„ #{{ detail.rank }}
                                </span>
                                <span class="text-sm text-gray-500">
                                    {{ detail.relevance_to_query }}
                                </span>
                            </div>
                            <h4 class="font-bold text-gray-900">{{ detail.precedent_info.title }}</h4>
                            <p class="text-sm text-gray-600">{{ detail.precedent_info.court }} | {{ detail.precedent_info.date }}</p>
                        </div>

                        <!-- ì‚¬ì‹¤ê´€ê³„ -->
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-900 mb-2">ğŸ“ ì‚¬ì‹¤ê´€ê³„</h5>
                            <p class="text-sm text-gray-700 bg-gray-50 p-3 rounded">{{ detail.case_facts }}</p>
                        </div>

                        <!-- ì£¼ìš” ìŸì  -->
                        {% if detail.key_issues %}
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-900 mb-2">âš–ï¸ ì£¼ìš” ìŸì </h5>
                            <div class="flex flex-wrap gap-2">
                                {% for issue in detail.key_issues %}
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">{{ issue }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- ì ìš© ë²•ë ¹ -->
                        {% if detail.applicable_laws %}
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-900 mb-2">ğŸ“– ì ìš© ë²•ë ¹</h5>
                            <div class="flex flex-wrap gap-2">
                                {% for law in detail.applicable_laws %}
                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">{{ law }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- ë²•ì›ì˜ íŒë‹¨ -->
                        <div class="mb-4">
                            <h5 class="font-semibold text-gray-900 mb-2">ğŸ›ï¸ ë²•ì›ì˜ íŒë‹¨</h5>
                            <p class="text-sm text-gray-700">{{ detail.court_reasoning }}</p>
                        </div>

                        <!-- ì‹œì‚¬ì  -->
                        <div>
                            <h5 class="font-semibold text-gray-900 mb-2">ğŸ’¡ ì‹œì‚¬ì </h5>
                            <p class="text-sm text-gray-700 bg-yellow-50 p-3 rounded">{{ detail.implications }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ì›ë³¸ ì§ˆì˜ ë° ê²€ìƒ‰ ì •ë³´ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“‹ ê²€ìƒ‰ ì§ˆì˜ ì •ë³´</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- ì›ë³¸ ì§ˆì˜ -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">ì›ë³¸ ì§ˆì˜</h4>
                        <p class="text-sm text-gray-700 leading-relaxed bg-gray-50 p-4 rounded">{{ analysis.query_text }}</p>
                    </div>
                    <!-- ê²€ìƒ‰ ì •ë³´ -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">ê²€ìƒ‰ ì •ë³´</h4>
                        <div class="space-y-2 text-sm bg-gray-50 p-4 rounded">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ìš”ì²­ ì‹œê°„:</span>
                                <span class="text-gray-900">
                                    {% if analysis.created_at %}
                                        {% if analysis.created_at is string %}
                                            {{ analysis.created_at[:16] }}
                                        {% else %}
                                            {{ analysis.created_at.strftime('%m/%d %H:%M') }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ì™„ë£Œ ì‹œê°„:</span>
                                <span class="text-gray-900">
                                    {% if analysis.updated_at %}
                                        {% if analysis.updated_at is string %}
                                            {{ analysis.updated_at[:16] }}
                                        {% else %}
                                            {{ analysis.updated_at.strftime('%m/%d %H:%M') }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ê²€ìƒ‰ ìœ í˜•:</span>
                                <span class="text-gray-900">{{ analysis.analysis_type }}</span>
                            </div>
                            {% if result.precedent_list %}
                            <div class="flex justify-between pt-2 border-t">
                                <span class="text-gray-600">ìœ ë¦¬ íŒë¡€:</span>
                                <span class="text-gray-900 font-medium text-green-600">
                                    {{ result.precedent_list|selectattr("favorability.assessment", "equalto", "ìœ ë¦¬")|list|length }}ê±´
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ë¶ˆë¦¬ íŒë¡€:</span>
                                <span class="text-gray-900 font-medium text-red-600">
                                    {{ result.precedent_list|selectattr("favorability.assessment", "equalto", "ë¶ˆë¦¬")|list|length }}ê±´
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
    </div>

    {% else %}
    <!-- ë°ì´í„° ì—†ìŒ -->
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</h3>
        <p class="text-gray-600">ê²€ìƒ‰ì´ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
</div>

<script>
// ì§„í–‰ì¤‘ ìƒíƒœì¼ ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨
{% if analysis.status == 'processing' %}
setTimeout(function() {
    location.reload();
}, 30000); // 30ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
{% endif %}
</script>
{% endblock %}