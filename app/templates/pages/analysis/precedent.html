{% extends "base.html" %}

{% block title %}ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰ - SANZERO{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<!-- í˜ì´ì§€ í—¤ë” -->
<section class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="text-gray-700 hover:text-blue-600">í™ˆ</a>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-gray-500">ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰</span>
          </div>
        </li>
      </ol>
    </nav>

    <h1 class="text-3xl font-bold text-gray-900 mb-2">ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰</h1>
    <p class="text-gray-600">ê·€í•˜ì˜ ì‚°ì—…ì¬í•´ ì‚¬ê±´ê³¼ ìœ ì‚¬í•œ íŒë¡€ë¥¼ ì°¾ì•„ ì¸ì • ë¹„ìœ¨ì„ ë¶„ì„í•´ë³´ì„¸ìš”</p>
  </div>
</section>

<div class="max-w-7xl mx-auto px-4 py-8">

    <div class="grid lg:grid-cols-3 gap-8">
        <!-- ë©”ì¸ ê²€ìƒ‰ ì˜ì—­ -->
        <div class="lg:col-span-2">
            <!-- íŒë¡€ ê²€ìƒ‰ í¼ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 mb-4">ğŸ” ê²€ìƒ‰</h2>
                <p class="text-sm text-blue-600 mb-4 font-medium">
                    âœ… AI ê¸°ë°˜ ìœ ì‚¬ë„ ë¶„ì„ìœ¼ë¡œ ê´€ë ¨ì„± ë†’ì€ íŒë¡€ë¥¼ ì •í™•í•˜ê²Œ ê²€ìƒ‰
                </p>

                <div class="mb-4">
                    <label for="simple_query" class="block text-sm font-medium text-gray-700 mb-2">
                        ê²€ìƒ‰ì–´ ì…ë ¥
                    </label>
                    <textarea
                        id="simple_query"
                        rows="3"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 validation-input"
                        placeholder="ì˜ˆ: ì‘ì—… ì¤‘ í”„ë ˆìŠ¤ ê¸°ê³„ì— ì†ê°€ë½ ë¼ì„ìœ¼ë¡œ ì¸í•œ ì ˆë‹¨ ì‚¬ê³ "
                        oninput="validateSearchQuery(this.value)"
                        onblur="validateSearchQuery(this.value)"
                    ></textarea>

                    <!-- ì‹¤ì‹œê°„ ê²€ì¦ ë©”ì‹œì§€ -->
                    <div id="query-validation-message" class="mt-2 text-sm hidden">
                        <div id="query-validation-content" class="flex items-start space-x-2">
                            <span id="query-validation-icon"></span>
                            <div>
                                <div id="query-validation-text"></div>
                                <div id="query-validation-examples" class="mt-2 text-xs hidden">
                                    <p class="font-medium mb-1">ì˜¬ë°”ë¥¸ ì˜ˆì‹œ:</p>
                                    <ul class="space-y-1 pl-3">
                                        <li>â€¢ ì‘ì—… ì¤‘ í”„ë ˆìŠ¤ ê¸°ê³„ì— ì†ê°€ë½ ë¼ì„ìœ¼ë¡œ ì¸í•œ ì ˆë‹¨ ì‚¬ê³ </li>
                                        <li>â€¢ ê±´ì„¤í˜„ì¥ ë¹„ê³„ ì¶”ë½ì‚¬ê³ ë¡œ ì¸í•œ ê³¨ì ˆìƒ</li>
                                        <li>â€¢ ìš©ì ‘ ì‘ì—… ì¤‘ í™”ìƒ ë¶€ìƒ</li>
                                        <li>â€¢ í¬ë ˆì¸ ì‘ì—… ì¤‘ ì¶©ëŒ ì‚¬ê³ </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4 mb-4">
                    <div>
                        <label for="result_count" class="block text-sm font-medium text-gray-700 mb-1">ê²°ê³¼ ìˆ˜</label>
                        <select id="result_count" class="border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="5">5ê°œ</option>
                            <option value="10" selected>10ê°œ</option>
                            <option value="15">15ê°œ</option>
                            <option value="20">20ê°œ</option>
                        </select>
                    </div>
                </div>

                <div class="flex">
                    <button
                        onclick="performSimpleSearch()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 w-full disabled:bg-gray-400 disabled:cursor-not-allowed focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                        id="searchButton"
                        disabled
                    >
                        ğŸ” íŒë¡€ ê²€ìƒ‰
                    </button>
                </div>
                <div id="search-disabled-message" class="mt-2 text-sm text-gray-500 text-center">
                    ì˜¬ë°”ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                </div>
            </div>

            <!-- ê²€ìƒ‰ ìƒíƒœ í‘œì‹œ -->
            <div id="search-status" class="hidden mb-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500 mr-3"></div>
                        <span class="text-blue-700">ê²€ìƒ‰ ì¤‘...</span>
                    </div>
                </div>
            </div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
            <div id="search-results" class="hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">ê²€ìƒ‰ ê²°ê³¼</h3>
                        <!-- ë ˆí¬íŠ¸ ì €ì¥ ë²„íŠ¼ -->
                        <button
                            id="save-report-btn"
                            onclick="generatePrecedentReport()"
                            class="hidden bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center space-x-2"
                            disabled
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>í…ìŠ¤íŠ¸ ë ˆí¬íŠ¸ ì €ì¥</span>
                        </button>
                    </div>
                    <div id="results-container"></div>
                </div>
            </div>

            <!-- ì—ëŸ¬ í‘œì‹œ ì˜ì—­ -->
            <div id="error-container" class="hidden">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex">
                        <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <h4 class="text-red-800 font-medium">ê²€ìƒ‰ ì˜¤ë¥˜</h4>
                            <p class="text-red-700" id="error-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‚¬ì´ë“œë°” -->
        <div>
            <!-- ê²€ìƒ‰ ê²°ê³¼ í†µê³„ ì°¨íŠ¸ -->
            <div id="statistics-section" class="hidden space-y-6 mb-6">
                <!-- ì¢…í•© ë¶„ì„ ìš”ì•½ -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-blue-900 mb-3">ğŸ¯ ì¢…í•© ë¶„ì„</h4>
                    <div id="comprehensive-analysis" class="text-blue-800 space-y-1 text-sm"></div>
                </div>


                <!-- ìƒìœ„ 3ê°œ íŒë¡€ ìƒì„¸ ë¹„êµí‘œ -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="text-md font-semibold text-gray-900 mb-3">ğŸ† ìƒìœ„ 3ê°œ íŒë¡€ ë¹„êµ</h4>
                    <div id="top3-comparison" class="text-sm"></div>
                </div>

                <!-- ìœ ë¶ˆë¦¬ ë¶„ì„ í†µê³„ -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h4 class="text-md font-semibold text-gray-900 mb-3">ğŸ“Š ìœ ì‚¬ íŒë¡€ ìœ ë¶ˆë¦¬ ë¶„ì„</h4>
                    <div class="mb-3" style="height: 200px;">
                        <canvas id="outcomeChart"></canvas>
                    </div>
                    <div id="outcome-summary" class="text-xs text-gray-600"></div>
                </div>

                <!-- ì‚¬ê³ ìœ í˜•ë³„ ë¶„í¬ -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h4 class="text-md font-semibold text-gray-900 mb-3">ğŸ­ ì‚¬ê³ ìœ í˜•</h4>
                    <div class="mb-3" style="height: 200px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div id="category-summary" class="text-xs text-gray-600"></div>
                </div>

            </div>

            <!-- ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ë²„íŠ¼ -->
            <div id="next-step-section" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-6 mb-6">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">ğŸ¯ ë¶„ì„ ì™„ë£Œ!</h3>
                    <p class="text-green-700 mb-4">íŒë¡€ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.</p>
                    <div class="flex justify-center">
                        <button onclick="goToDisabilityPrediction()"
                                class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                            ì¥í•´ë“±ê¸‰ ì˜ˆì¸¡
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ ì •ë³´ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ¯ ê²€ìƒ‰ íŠ¹ì§•</h3>
                <ul class="text-blue-700 space-y-2 text-sm">
                    <li>âœ… AI ê¸°ë°˜ ì •í™•í•œ ìœ ì‚¬ë„ ë¶„ì„</li>
                    <li>âœ… ì¸ì • ë¹„ìœ¨ ë†’ì€ ì‚¬ë¡€ ìš°ì„ </li>
                    <li>âœ… ê´€ë ¨ì„± ë†’ì€ íŒë¡€ë§Œ ì„ ë³„</li>
                    <li>âœ… ì‹¤ì œ ë³´ìƒ ê²°ê³¼ í¬í•¨</li>
                    <li>âœ… ë¹ ë¥¸ ê²€ìƒ‰ ì†ë„ (í‰ê·  3ì´ˆ)</li>
                </ul>
            </div>

            <!-- ìµœê·¼ ê²€ìƒ‰ì–´ ì˜ˆì‹œ -->
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">ğŸ’¡ ì¶”ì²œ ê²€ìƒ‰ì–´</h3>
                <div class="space-y-2">
                    <button
                        onclick="setQuery('ì‘ì—… ì¤‘ í”„ë ˆìŠ¤ ê¸°ê³„ì— ì†ê°€ë½ ë¼ì„')"
                        class="block w-full text-left text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors duration-200"
                    >
                        ì‘ì—… ì¤‘ í”„ë ˆìŠ¤ ê¸°ê³„ì— ì†ê°€ë½ ë¼ì„
                    </button>
                    <button
                        onclick="setQuery('ê±´ì„¤í˜„ì¥ ë¹„ê³„ ì¶”ë½ ì‚¬ê³ ')"
                        class="block w-full text-left text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors duration-200"
                    >
                        ê±´ì„¤í˜„ì¥ ë¹„ê³„ ì¶”ë½ ì‚¬ê³ 
                    </button>
                    <button
                        onclick="setQuery('ìš©ì ‘ ì‘ì—… ì¤‘ í™”ìƒ ë¶€ìƒ')"
                        class="block w-full text-left text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors duration-200"
                    >
                        ìš©ì ‘ ì‘ì—… ì¤‘ í™”ìƒ ë¶€ìƒ
                    </button>
                    <button
                        onclick="setQuery('í¬ë ˆì¸ ì‘ì—… ì¤‘ ì¶©ëŒ ì‚¬ê³ ')"
                        class="block w-full text-left text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors duration-200"
                    >
                        í¬ë ˆì¸ ì‘ì—… ì¤‘ ì¶©ëŒ ì‚¬ê³ 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// ğŸš€ íŒë¡€ ê²€ìƒ‰ JavaScript Functions
// ============================================================================

// ============================================================================
// ğŸ” ì‹¤ì‹œê°„ ì…ë ¥ ê²€ì¦ Functions
// ============================================================================

function validateSearchQuery(query) {
    const messageElement = document.getElementById('query-validation-message');
    const iconElement = document.getElementById('query-validation-icon');
    const textElement = document.getElementById('query-validation-text');
    const examplesElement = document.getElementById('query-validation-examples');
    const inputElement = document.getElementById('simple_query');
    const buttonElement = document.getElementById('searchButton');
    const disabledMessageElement = document.getElementById('search-disabled-message');

    // ê²€ì¦ ì´ˆê¸°í™”
    let isValid = false;
    let validationType = '';
    let message = '';

    if (!query || query.trim().length === 0) {
        // ë¹ˆ ì…ë ¥
        validationType = 'empty';
        isValid = false;
        message = '';
    } else if (query.trim().length < 5) {
        // ë„ˆë¬´ ì§§ì€ ì…ë ¥
        validationType = 'short';
        isValid = false;
        message = 'ê²€ìƒ‰ì–´ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    } else if (isMeaninglessText(query.trim())) {
        // ë¬´ì˜ë¯¸í•œ í…ìŠ¤íŠ¸
        validationType = 'meaningless';
        isValid = false;
        message = 'ì˜ë¯¸ìˆëŠ” ì‚¬ê³  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ë‹¨ìˆœ ë°˜ë³µ ë¬¸ìëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
    } else if (!containsAccidentKeywords(query.trim())) {
        // ì‚°ì¬ í‚¤ì›Œë“œ ì—†ìŒ
        validationType = 'no_keywords';
        isValid = false;
        message = 'ì‚°ì—…ì¬í•´ ê´€ë ¨ ë‚´ìš©ì„ í¬í•¨í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì‘ì—…, ì‚¬ê³ , ë¶€ìƒ, ê¸°ê³„ ë“±)';
    } else {
        // ìœ íš¨í•œ ì…ë ¥
        validationType = 'valid';
        isValid = true;
        message = 'ì¢‹ì€ ê²€ìƒ‰ì–´ì…ë‹ˆë‹¤! ìœ ì‚¬í•œ íŒë¡€ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.';
    }

    // UI ì—…ë°ì´íŠ¸
    updateValidationUI(validationType, message, {
        messageElement,
        iconElement,
        textElement,
        examplesElement,
        inputElement,
        buttonElement,
        disabledMessageElement
    });

    return {
        isValid,
        message,
        type: validationType
    };
}

function isMeaninglessText(text) {
    // 1. ë°˜ë³µ ë¬¸ì ì²´í¬ (3ê¸€ì ì´ìƒ ì—°ì†)
    const repeatingPattern = /(.)\1{2,}/;
    if (repeatingPattern.test(text)) {
        return true;
    }

    // 2. ë‹¨ìˆœ íŒ¨í„´ ì²´í¬
    const simplePatterns = [
        /^[a-zA-Z]\1*$/,  // aaaa, bbbb ë“±
        /^[0-9]+$/,       // ìˆ«ìë§Œ
        /^[ã„±-ã…ã…-ã…£]+$/, // ììŒëª¨ìŒë§Œ
        /^[!@#$%^&*()_+=-]+$/, // íŠ¹ìˆ˜ë¬¸ìë§Œ
        /^(.{1,3})\1{2,}$/ // ì§§ì€ íŒ¨í„´ ë°˜ë³µ
    ];

    return simplePatterns.some(pattern => pattern.test(text));
}

function containsAccidentKeywords(text) {
    const accidentKeywords = [
        // ê¸°ë³¸ ì‚°ì¬ í‚¤ì›Œë“œ
        'ì‘ì—…', 'ì‚¬ê³ ', 'ë¶€ìƒ', 'ì¬í•´', 'ì•ˆì „', 'ê¸°ê³„',
        // ì‚¬ê³  ìœ í˜•
        'ì¶”ë½', 'ë‚™í•˜', 'ë¼ì„', 'ì ˆë‹¨', 'ì¶©ëŒ', 'í™”ìƒ', 'ê°ì „', 'ì¤‘ë…',
        // ì‘ì—… í™˜ê²½
        'ê³µì¥', 'ê±´ì„¤', 'í˜„ì¥', 'í¬ë ˆì¸', 'í”„ë ˆìŠ¤', 'ìš©ì ‘', 'í™”ì¬',
        // ì‹ ì²´ ë¶€ìœ„
        'ì†ê°€ë½', 'íŒ”', 'ë‹¤ë¦¬', 'ë¨¸ë¦¬', 'ëˆˆ', 'í—ˆë¦¬',
        // ì˜ë£Œ ê´€ë ¨
        'ê³¨ì ˆ', 'ìƒì²˜', 'í™”ìƒ', 'íƒ€ë°•ìƒ', 'ì—¼ì¢Œ'
    ];

    const lowerText = text.toLowerCase();
    return accidentKeywords.some(keyword =>
        lowerText.includes(keyword) || text.includes(keyword)
    );
}

function updateValidationUI(type, message, elements) {
    const {
        messageElement, iconElement, textElement, examplesElement,
        inputElement, buttonElement, disabledMessageElement
    } = elements;

    // ë©”ì‹œì§€ í‘œì‹œ/ìˆ¨ê¹€
    if (type === 'empty') {
        messageElement.classList.add('hidden');
        inputElement.className = inputElement.className.replace(/ validation-\w+/g, '');
        buttonElement.disabled = true;
        disabledMessageElement.classList.remove('hidden');
        return;
    }

    messageElement.classList.remove('hidden');

    // ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼
    inputElement.className = inputElement.className.replace(/ validation-\w+/g, '');

    if (type === 'valid') {
        inputElement.classList.add('validation-success');
        iconElement.textContent = 'âœ…';
        textElement.className = 'text-green-700 font-medium';
        examplesElement.classList.add('hidden');
        buttonElement.disabled = false;
        disabledMessageElement.classList.add('hidden');
    } else {
        inputElement.classList.add('validation-error');
        iconElement.textContent = 'âŒ';
        textElement.className = 'text-red-700 font-medium';

        if (type === 'meaningless' || type === 'no_keywords') {
            examplesElement.classList.remove('hidden');
        } else {
            examplesElement.classList.add('hidden');
        }

        buttonElement.disabled = true;
        disabledMessageElement.classList.remove('hidden');
    }

    textElement.textContent = message;
}

function setQuery(query) {
    document.getElementById('simple_query').value = query;
    // ê²€ì¦ ì‹¤í–‰
    validateSearchQuery(query);
}

async function performSimpleSearch() {
    const query = document.getElementById('simple_query').value.trim();
    const resultCount = document.getElementById('result_count').value;

    // ì…ë ¥ ê²€ì¦
    const validation = validateSearchQuery(query);
    if (!validation.isValid) {
        showError(validation.message);
        return;
    }

    showLoading(true);
    hideError();
    hideResults();

    try {
        console.log('ğŸ” Starting simple search:', query);

        const response = await fetch('/analysis/api/precedent/simple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `query=${encodeURIComponent(query)}&top_k=${resultCount}`
        });

        const data = await response.json();
        console.log('ğŸ“Š Search response:', data);

        showLoading(false);

        if (data.success && data.results && data.results.length > 0) {
            displayResults(data);
        } else {
            showError(data.message || 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }

    } catch (error) {
        console.error('âŒ Search error:', error);
        showLoading(false);
        showError(`ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    }
}

function displayResults(data) {
    const container = document.getElementById('results-container');
    const resultsDiv = document.getElementById('search-results');

    let html = `
        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 class="font-medium text-green-800">âœ… ê²€ìƒ‰ ì™„ë£Œ</h4>
            <p class="text-sm text-green-600">
                ê²€ìƒ‰ì–´: "${data.query}" | ì´ ${data.total_results}ê°œ ê²°ê³¼ | ê²€ìƒ‰ ë°©ì‹: ${data.search_type}
            </p>
        </div>
    `;

    data.results.forEach((result, index) => {
        // ì‚¬ê³ ìœ í˜•ì— ë”°ë¥¸ ì•„ì´ì½˜ ì„¤ì •
        let categoryIcon = 'âš¡';
        if (result.category === 'ì¶”ë½ì‚¬ê³ ') categoryIcon = 'ğŸªœ';
        else if (result.category === 'ê¸°ê³„ì‚¬ê³ ') categoryIcon = 'âš™ï¸';
        else if (result.category === 'í™”ì¬ì‚¬ê³ ') categoryIcon = 'ğŸ”¥';
        else if (result.category === 'êµí†µì‚¬ê³ ') categoryIcon = 'ğŸš—';
        else if (result.category === 'ì¤‘ë…ì‚¬ê³ ') categoryIcon = 'â˜£ï¸';
        else if (result.category === 'ê°ì „ì‚¬ê³ ') categoryIcon = 'âš¡';

        // title(ìŸì )ê³¼ kinda(íŒê²°ê²°ê³¼) ì •ë³´ ì²˜ë¦¬
        const title = result.title || '';
        const kinda = result.kinda || '';
        const hasKinda = kinda && kinda.trim() !== '';

        html += `
            <div class="precedent-card border border-gray-200 rounded-lg p-5 mb-4 bg-white">
                <!-- ì¹´ë“œ í—¤ë” -->
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-lg font-semibold text-gray-900">
                        ${index + 1}ë²ˆ íŒë¡€
                    </h4>
                    <div class="flex items-center text-sm text-gray-500">
                        <span class="mr-2">${categoryIcon} ${result.category}</span>
                        <span>${result.accnum || 'ë¯¸ìƒ'}</span>
                    </div>
                </div>

                <!-- í•µì‹¬ ì •ë³´ -->
                <div class="space-y-3 mb-4">
                    <!-- ìŸì  -->
                    <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-r">
                        <div class="flex">
                            <span class="text-amber-600 font-semibold mr-2">ğŸ¯</span>
                            <div>
                                <h5 class="font-medium text-amber-800 mb-1">ìŸì </h5>
                                <p class="text-sm text-amber-700">${title}</p>
                            </div>
                        </div>
                    </div>

                    ${hasKinda ? `
                    <!-- íŒê²°ê²°ê³¼ -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r">
                        <div class="flex">
                            <span class="text-blue-600 font-semibold mr-2">âš–ï¸</span>
                            <div>
                                <h5 class="font-medium text-blue-800 mb-1">íŒê²°ê²°ê³¼</h5>
                                <p class="text-sm text-blue-700">${kinda}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${result.case_type ? `
                    <!-- ì‚¬ê±´ë¶„ì•¼ -->
                    <div class="bg-gray-50 border-l-4 border-gray-400 p-3 rounded-r">
                        <div class="flex">
                            <span class="text-gray-600 font-semibold mr-2">ğŸ“‹</span>
                            <div>
                                <h5 class="font-medium text-gray-700 mb-1">ì‚¬ê±´ë¶„ì•¼</h5>
                                <p class="text-sm text-gray-600">${result.case_type}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- ë²•ì› ì •ë³´ -->
                <div class="text-sm text-gray-600 mb-4 p-2 bg-gray-50 rounded">
                    <span class="font-medium">ë²•ì›:</span> ${result.court}
                </div>

                <!-- íŒë¡€ ë‚´ìš© ìš”ì•½ (ì²˜ìŒ 200ì) -->
                <div class="mb-4">
                    <h5 class="font-medium text-gray-800 mb-2">ğŸ“„ íŒë¡€ ìš”ì•½</h5>
                    <p class="text-sm text-gray-700 leading-relaxed line-clamp-3">
                        ${result.content.length > 200 ? result.content.substring(0, 200) + '...' : result.content}
                    </p>
                </div>

                <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                    <span class="text-xs text-gray-400">Case ID: ${result.case_id}</span>
                    <div class="flex space-x-2">
                        <button onclick="viewPrecedentDetail('${result.case_id}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ğŸ“„ ìƒì„¸ ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    resultsDiv.classList.remove('hidden');

    // í†µê³„ ì°¨íŠ¸ ìƒì„± (Chart.js í•„ìš”ì‹œ ë¡œë”©)
    if (data.results && data.results.length > 0) {
        // Chart.jsê°€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ë¡œë”©
        if (window.loadChartJSIfNeeded) {
            window.loadChartJSIfNeeded().then(() => {
                generateStatistics(data.results);
                showStatistics();
            });
        } else {
            // fallback: Chart.jsê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ” ê²½ìš°
            generateStatistics(data.results);
            showStatistics();
        }
    }

    // ë ˆí¬íŠ¸ ìƒì„±ì„ ìœ„í•œ ë°ì´í„° ì—…ë°ì´íŠ¸
    updateCurrentSearchData(data);

    // ë ˆí¬íŠ¸ ë²„íŠ¼ í‘œì‹œ
    updateReportButtonVisibility();

    // ë‹¤ìŒ ë‹¨ê³„ ì„¹ì…˜ í‘œì‹œ
    showNextStepSection();
}


function showLoading(show) {
    const statusDiv = document.getElementById('search-status');
    const searchButton = document.getElementById('searchButton');

    if (show) {
        statusDiv.classList.remove('hidden');
        searchButton.disabled = true;
        searchButton.innerHTML = 'ğŸ”„ ê²€ìƒ‰ ì¤‘...';
    } else {
        statusDiv.classList.add('hidden');
        searchButton.disabled = false;
        searchButton.innerHTML = 'ğŸ” íŒë¡€ ê²€ìƒ‰';
    }
}

function hideResults() {
    document.getElementById('search-results').classList.add('hidden');
    document.getElementById('statistics-section').classList.add('hidden');
}

function hideStatistics() {
    document.getElementById('statistics-section').classList.add('hidden');
}

function showStatistics() {
    document.getElementById('statistics-section').classList.remove('hidden');
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-container').classList.remove('hidden');
}

function hideError() {
    document.getElementById('error-container').classList.add('hidden');
}

function viewPrecedentDetail(caseId) {
    // ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = `/analysis/precedent/${caseId}`;
}

// ============================================================================
// ğŸ“Š í†µê³„ ì°¨íŠ¸ ìƒì„± Functions
// ============================================================================

let outcomeChart, categoryChart, timeChart;

function generateStatistics(results) {
    console.log('ğŸ“Š Generating statistics for', results.length, 'results');

    // í†µê³„ ë°ì´í„° ë¶„ì„
    const stats = analyzeResults(results);

    // Chart.js ë¡œë”© ëŒ€ê¸° í•¨ìˆ˜
    function waitForChartJS(maxWait = 3000, checkInterval = 100) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();

            function check() {
                // Chart.js ë¡œë“œ í™•ì¸
                if (typeof Chart !== 'undefined' && Chart.version) {
                    console.log('âœ… Chart.js ready:', Chart.version);
                    resolve(true);
                    return;
                }

                // ì „ì—­ ì‹¤íŒ¨ í”Œë˜ê·¸ í™•ì¸
                if (window.chartJSFailed) {
                    console.log('âŒ Chart.js loading failed (global flag)');
                    resolve(false);
                    return;
                }

                // ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼
                if (Date.now() - startTime > maxWait) {
                    console.warn('â° Chart.js loading timeout');
                    resolve(false);
                    return;
                }

                // ê³„ì† ëŒ€ê¸°
                setTimeout(check, checkInterval);
            }

            check();
        });
    }

    // Chart.js ë¡œë”© ëŒ€ê¸° í›„ ì°¨íŠ¸ ìƒì„±
    waitForChartJS().then((chartJSReady) => {
        if (chartJSReady) {
            console.log('ğŸ“Š Using Chart.js for visualization');

            // ê¸°ì¡´ ì°¨íŠ¸ ì •ë¦¬
            destroyExistingCharts();

            // Chart.js ì°¨íŠ¸ ìƒì„±
            setTimeout(() => {
                createOutcomeChart(stats.outcomes);
                createCategoryChart(stats.categories);

                // ì¢…í•© ë¶„ì„ ìƒì„±
                generateComprehensiveAnalysis(stats, results.length);

                // ìƒìœ„ 3ê°œ íŒë¡€ ìƒì„¸ ë¹„êµí‘œ ìƒì„±
                generateTop3Comparison(results.slice(0, 3));
            }, 100);
        } else {
            console.warn('âš ï¸ Chart.js not available, using fallback visualization');
            createFallbackVisualization(stats, results.length);

            // fallbackì—ì„œë„ ë¶„ì„ê³¼ ë¹„êµí‘œëŠ” ìƒì„±
            generateComprehensiveAnalysis(stats, results.length);
            generateTop3Comparison(results.slice(0, 3));
        }
    });
}

function createFallbackVisualization(stats, totalResults) {
    // Chart.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ë•Œ ì‚¬ìš©í•  ëŒ€ì²´ ì‹œê°í™”
    console.log('ğŸ”§ Creating fallback visualization for', totalResults, 'results');

    // ì•ˆì „í•œ ìœ ë¦¬ë„ ê³„ì‚° (Test_casePedia ë°©ì‹)
    const favorableCount = stats.outcomes['ìœ ë¦¬'] || 0;
    const favorableRate = totalResults > 0 ? (favorableCount / totalResults * 100).toFixed(1) : 0;

    // ì£¼ìš” ì¹´í…Œê³ ë¦¬ ì•ˆì „í•˜ê²Œ ê³„ì‚°
    const categoryEntries = Object.entries(stats.categories || {});
    const mainCategory = categoryEntries.length > 0 ? categoryEntries.sort((a, b) => b[1] - a[1])[0][0] : 'ì¶”ë½ì‚¬ê³ ';

    // ì¢…í•© ë¶„ì„ ìƒì„±
    generateComprehensiveAnalysis(stats, totalResults);

    // ìœ ë¦¬ë„ ì§„í–‰ë°” ìƒì„± (ìº”ë²„ìŠ¤ ë¶€ëª¨ div ë‚´ìš© êµì²´) - Chart.js ìŠ¤íƒ€ì¼ ëª¨ì‚¬
    const outcomeChart = document.getElementById('outcomeChart');
    const outcomeSummary = document.getElementById('outcome-summary');

    if (outcomeChart && outcomeChart.parentElement) {
        const colorMap = {
            'ìœ ë¦¬': '#22C55E',    // green-500
            'ë¶ˆë¦¬': '#EF4444'     // red-500
        };

        const outcomeEntries = Object.entries(stats.outcomes || {}).filter(([k,v]) => v > 0);
        const rateColor = favorableRate >= 70 ? 'text-green-600' : favorableRate >= 50 ? 'text-blue-600' : 'text-amber-600';

        outcomeChart.parentElement.innerHTML = `
            <div class="p-3 bg-white rounded-lg border border-gray-100">
                <div class="text-center mb-3">
                    <span class="text-xl font-bold ${rateColor}">${favorableRate}%</span>
                    <div class="text-xs text-gray-600">í‰ê·  ìœ ë¦¬ë„</div>
                </div>

                <!-- ë„ë„› ì°¨íŠ¸ ìŠ¤íƒ€ì¼ ëª¨ì‚¬ -->
                <div class="relative w-32 h-32 mx-auto mb-3">
                    <div class="absolute inset-0 rounded-full border-8 border-gray-200"></div>
                    <div class="absolute inset-0 rounded-full border-8 border-green-500 border-r-transparent border-b-transparent transform rotate-45"
                         style="border-right-color: transparent; border-bottom-color: transparent;
                                border-top-color: ${favorableRate >= 70 ? '#22C55E' : favorableRate >= 50 ? '#3B82F6' : '#F59E0B'};
                                border-left-color: ${favorableRate >= 70 ? '#22C55E' : favorableRate >= 50 ? '#3B82F6' : '#F59E0B'};">
                    </div>
                    <div class="absolute inset-4 flex items-center justify-center">
                        <span class="text-sm font-semibold text-gray-700">${favorableRate}%</span>
                    </div>
                </div>

                <div class="text-xs text-gray-600 space-y-1">
                    ${outcomeEntries.map(([key, val]) => {
                        const color = colorMap[key] || '#6B7280';
                        return `<div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${color}"></div>
                                <span>${key}</span>
                            </div>
                            <span class="font-medium">${val}ê±´</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
    if (outcomeSummary) {
        outcomeSummary.innerHTML = `ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}`;
    }

    // ì¹´í…Œê³ ë¦¬ ë§‰ëŒ€ ê·¸ë˜í”„ (ìº”ë²„ìŠ¤ ë¶€ëª¨ div ë‚´ìš© êµì²´)
    const categoryChart = document.getElementById('categoryChart');
    const categorySummary = document.getElementById('category-summary');

    if (categoryChart && categoryChart.parentElement) {
        categoryChart.parentElement.innerHTML = `
            <div class="p-3">
                <div class="space-y-2">
                    ${Object.entries(stats.categories || {}).map(([category, count], index) => {
                        const percentage = totalResults > 0 ? (count / totalResults * 100).toFixed(1) : 0;
                        const colors = ['bg-purple-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500'];
                        return `
                            <div class="text-xs">
                                <div class="flex justify-between mb-1">
                                    <span class="text-gray-700">${category}</span>
                                    <span class="text-gray-600">${count}ê±´ (${percentage}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded h-2">
                                    <div class="${colors[index % colors.length]} h-2 rounded transition-all duration-500" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
    if (categorySummary) {
        categorySummary.innerHTML = `ì´ ${totalResults}ê±´ ë¶„ì„`;
    }

    console.log('âœ… Fallback visualization created successfully');
}

function destroyExistingCharts() {
    if (outcomeChart) {
        outcomeChart.destroy();
        outcomeChart = null;
    }
    if (categoryChart) {
        categoryChart.destroy();
        categoryChart = null;
    }
}

function analyzeResults(results) {
    console.log('ğŸ” Analyzing real precedent data:', results);

    const outcomes = { 'ìœ ë¦¬': 0, 'ë¶ˆë¦¬': 0 };
    const categories = {};
    const courts = {};
    const similarities = [];

    results.forEach((result, index) => {
        console.log(`ğŸ“‹ Analyzing case ${index + 1}:`, result);

        // 1. ìœ ë¶ˆë¦¬ ë¶„ì„ (ì‹¤ì œ íŒë¡€ ì œëª©ê³¼ ë‚´ìš© ë¶„ì„) - predictOutcomeê³¼ ë™ì¼í•œ ë¡œì§
        const title = result.title ? result.title : '';
        const content = result.content ? result.content : '';
        const titleLower = title.toLowerCase();
        const contentLower = content.toLowerCase();

        // Test_casePedia.ipynb ì›ë³¸ í‚¤ì›Œë“œ ì ìš©
        const favorableKeywords = [
            'ì²­êµ¬ì¸ìš©', 'ì›ê³ ìŠ¹ì†Œ', 'ì›ê³  ìŠ¹ì†Œ', 'ì¸ìš©í•œë‹¤', 'ì·¨ì†Œí•œë‹¤',
            'ì›ì²˜ë¶„ì„ ì·¨ì†Œ', 'ì²˜ë¶„ì„ ì·¨ì†Œ', 'í•­ì†Œë¥¼ ê¸°ê°', 'ìƒê³ ë¥¼ ê¸°ê°',
            'ì—…ë¬´ìƒ ì¬í•´ë¡œ ì¸ì •', 'ì—…ë¬´ìƒ ì§ˆë³‘ìœ¼ë¡œ ì¸ì •', 'ì—…ë¬´ìƒ ì‚¬ê³ ë¡œ ì¸ì •',
            'ìš”ì–‘ê¸‰ì—¬ë¥¼ ì§€ê¸‰', 'ì¥í•´ê¸‰ì—¬ë¥¼ ì§€ê¸‰', 'ìœ ì¡±ê¸‰ì—¬ë¥¼ ì§€ê¸‰'
        ];

        const unfavorableKeywords = [
            'ì²­êµ¬ê¸°ê°', 'ì²­êµ¬ë¥¼ ê¸°ê°', 'ì›ê³ íŒ¨ì†Œ', 'ì›ê³  íŒ¨ì†Œ', 'ê¸°ê°í•œë‹¤',
            'í•­ì†Œë¥¼ ì¸ìš©', 'ìƒê³ ë¥¼ ì¸ìš©', 'ì›ì‹¬ì„ íŒŒê¸°',
            'ì—…ë¬´ìƒ ì¬í•´ë¡œ ì¸ì •í•  ìˆ˜ ì—†', 'ì—…ë¬´ìƒ ì§ˆë³‘ìœ¼ë¡œ ë³¼ ìˆ˜ ì—†',
            'ìƒë‹¹ì¸ê³¼ê´€ê³„ê°€ ì—†', 'ìƒë‹¹ì¸ê³¼ê´€ê³„ë¥¼ ì¸ì •í•  ìˆ˜ ì—†',
            'ì—…ë¬´ì™€ ë¬´ê´€', 'ì‚¬ì  í–‰ìœ„', 'ê°œì¸ì  ì‚¬ì •',
            'ë¶ˆìŠ¹ì¸ ì²˜ë¶„ì€ ì ë²•', 'ë¶ˆì§€ê¸‰ ì²˜ë¶„ì€ ì •ë‹¹'
        ];

        // Test_casePedia.ipynb ì›ë³¸ ë¶„ì„ ë°©ì‹ êµ¬í˜„
        // 1. kinda ê°’(íŒê²°ê²°ê³¼) ì§ì ‘ í™œìš© (ê°€ì¥ ìš°ì„ ìˆœìœ„)
        const kinda = (result.kinda || '').toLowerCase();
        let kindaFavorable = 0;
        let kindaUnfavorable = 0;

        // íŒê²°ê²°ê³¼ë³„ ë¶„ë¥˜
        const favorableOutcomes = ['ì·¨ì†Œ', 'ì¸ìš©', 'ìŠ¹ì†Œ', 'ìŠ¹ì¸', 'ì§€ê¸‰'];
        const unfavorableOutcomes = ['ê¸°ê°', 'ê°í•˜', 'íŒ¨ì†Œ', 'ê±°ë¶€', 'ë¶ˆì¸ì •', 'ì·¨í•˜'];

        for (const outcome of favorableOutcomes) {
            if (kinda.includes(outcome)) {
                kindaFavorable += 5; // íŒê²°ê²°ê³¼ëŠ” ìµœê³  ê°€ì¤‘ì¹˜
                break;
            }
        }

        for (const outcome of unfavorableOutcomes) {
            if (kinda.includes(outcome)) {
                kindaUnfavorable += 5; // íŒê²°ê²°ê³¼ëŠ” ìµœê³  ê°€ì¤‘ì¹˜
                break;
            }
        }

        // 2. ë¬¸ì„œì˜ ë§ˆì§€ë§‰ 30% ë¶€ë¶„(ê²°ë¡ ) ì¶”ì¶œ
        const textLen = contentLower.length;
        const conclusion = contentLower.substring(Math.floor(textLen * 0.7)); // ë§ˆì§€ë§‰ 30%

        // 3. ê²°ë¡  ë¶€ë¶„ì—ì„œ í‚¤ì›Œë“œ ì¹´ìš´íŠ¸ (ê°€ì¤‘ì¹˜ 2ë°°)
        let favConclusion = 0;
        let unfConclusion = 0;

        for (const keyword of favorableKeywords) {
            const keywordLower = keyword.toLowerCase();
            if (conclusion.includes(keywordLower)) {
                favConclusion += 2; // ê²°ë¡  ë¶€ë¶„ ê°€ì¤‘ì¹˜
            }
        }

        for (const keyword of unfavorableKeywords) {
            const keywordLower = keyword.toLowerCase();
            if (conclusion.includes(keywordLower)) {
                unfConclusion += 2; // ê²°ë¡  ë¶€ë¶„ ê°€ì¤‘ì¹˜
            }
        }

        // 4. ì „ì²´ ë¬¸ì„œì—ì„œ í‚¤ì›Œë“œ ì¹´ìš´íŠ¸ (ê¸°ë³¸ ê°€ì¤‘ì¹˜ 1ë°°)
        let favTotal = 0;
        let unfTotal = 0;

        for (const keyword of favorableKeywords) {
            const keywordLower = keyword.toLowerCase();
            if (contentLower.includes(keywordLower) || titleLower.includes(keywordLower)) {
                favTotal += 1;
            }
        }

        for (const keyword of unfavorableKeywords) {
            const keywordLower = keyword.toLowerCase();
            if (contentLower.includes(keywordLower) || titleLower.includes(keywordLower)) {
                unfTotal += 1;
            }
        }

        // 5. í•©ì‚° ì ìˆ˜ ê³„ì‚° (kinda í¬í•¨)
        const favorableScore = kindaFavorable + favConclusion + favTotal;
        const unfavorableScore = kindaUnfavorable + unfConclusion + unfTotal;

        // Test_casePedia.ipynb ì›ë³¸ íŒì • ë¡œì§ ê·¸ëŒ€ë¡œ ì ìš© (2ê°€ì§€ ë¶„ë¥˜)
        if (favorableScore > unfavorableScore + 2) {
            outcomes['ìœ ë¦¬']++;  // ìœ ë¦¬ O: favorableì´ 2ì  ì´ìƒ ë†’ìœ¼ë©´
        } else {
            outcomes['ë¶ˆë¦¬']++;  // ë¶ˆë¦¬ X: ê·¸ ì™¸ ëª¨ë“  ê²½ìš° (ì• ë§¤ í¬í•¨)
        }

        // 2. ì‚¬ê³ ìœ í˜•ë³„ ë¶„ë¥˜ (ì‹¤ì œ ì¹´í…Œê³ ë¦¬ ì‚¬ìš©)
        let category = result.category;
        if (!category || category === 'ê¸°íƒ€') {
            // ë‚´ìš©ì—ì„œ ì‚¬ê³ ìœ í˜• ì¶”ì •
            if (contentLower.includes('ì¶”ë½') || titleLower.includes('ì¶”ë½')) category = 'ì¶”ë½ì‚¬ê³ ';
            else if (contentLower.includes('ê¸°ê³„') || titleLower.includes('ê¸°ê³„') ||
                    contentLower.includes('ë¼ì„') || contentLower.includes('ì ˆë‹¨')) category = 'ê¸°ê³„ì‚¬ê³ ';
            else if (contentLower.includes('í™”ìƒ') || titleLower.includes('í™”ì¬')) category = 'í™”ì¬ì‚¬ê³ ';
            else if (contentLower.includes('ê°ì „') || titleLower.includes('ì „ê¸°')) category = 'ê°ì „ì‚¬ê³ ';
            else if (contentLower.includes('êµí†µ') || titleLower.includes('ì°¨ëŸ‰')) category = 'êµí†µì‚¬ê³ ';
            else category = 'ì‚°ì—…ì¬í•´';
        }
        categories[category] = (categories[category] || 0) + 1;

        // 3. ë²•ì›ë³„ ë¶„ì„
        const court = result.court || 'ê¸°íƒ€ ë²•ì›';
        courts[court] = (courts[court] || 0) + 1;

        // 4. ìœ ì‚¬ë„ ìˆ˜ì§‘
        if (result.similarity_pct) {
            similarities.push(result.similarity_pct);
        }
    });

    // ë¶„ì„ ê²°ê³¼ ë¡œê¹…
    console.log('ğŸ“Š Analysis results:', {
        outcomes,
        categories,
        courts,
        avg_similarity: similarities.length > 0 ?
            (similarities.reduce((a, b) => a + b, 0) / similarities.length).toFixed(2) : 0
    });

    return { outcomes, categories, courts, similarities };
}

function createOutcomeChart(outcomes) {
    try {
        const ctx = document.getElementById('outcomeChart');
        if (!ctx) {
            console.error('âŒ outcomeChart canvas not found');
            return;
        }

        const total = Object.values(outcomes).reduce((a, b) => a + b, 0);
        if (total === 0) {
            console.log('âš ï¸ No data for outcome chart');
            return;
        }

        // ë°ì´í„° í•„í„°ë§ (0ë³´ë‹¤ í° ê°’ë§Œ)
        const filteredData = Object.entries(outcomes)
            .filter(([key, value]) => value > 0)
            .map(([key, value]) => ({ label: key, value }));

        // shadcn ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì ìš© (Test_casePedia ë°©ì‹)
        const colorMap = {
            'ìœ ë¦¬': '#22C55E',    // green-500
            'ë¶ˆë¦¬': '#EF4444'     // red-500
        };

        outcomeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: filteredData.map(d => d.label),
                datasets: [{
                    data: filteredData.map(d => d.value),
                    backgroundColor: filteredData.map(d => colorMap[d.label] || '#6B7280'),
                    borderWidth: 2,
                    borderColor: '#FFFFFF',
                    hoverBorderWidth: 3,
                    hoverBorderColor: '#F1F5F9'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 11,
                                weight: 500
                            },
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        titleColor: '#F9FAFB',
                        bodyColor: '#F9FAFB',
                        borderColor: '#374151',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed}ê±´ (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 800
                }
            }
        });

        // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ (Test_casePedia ë°©ì‹)
        const favorableCount = outcomes['ìœ ë¦¬'] || 0;
        const favorableRate = ((favorableCount / total) * 100).toFixed(1);

        document.getElementById('outcome-summary').innerHTML = `
            <div class="space-y-1">
                <p class="text-xs"><strong>í‰ê·  ìœ ë¦¬ë„:</strong> ${favorableRate}%</p>
                <p class="text-xs ${favorableRate >= 70 ? 'text-green-600' : favorableRate >= 50 ? 'text-blue-600' : 'text-amber-600'}">
                    ${favorableRate >= 70 ? 'âœ… ë§¤ìš° ìœ ë¦¬í•¨' : favorableRate >= 50 ? 'âš–ï¸ ë³´í†µ' : 'âš ï¸ ì‹ ì¤‘í•œ ì ‘ê·¼ í•„ìš”'}
                </p>
            </div>
        `;

        console.log('âœ… Outcome doughnut chart created successfully');
    } catch (error) {
        console.error('âŒ Error creating outcome chart:', error);
    }
}

function createCategoryChart(categories) {
    try {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) {
            console.error('âŒ categoryChart canvas not found');
            return;
        }

        const categoryEntries = Object.entries(categories)
            .filter(([key, value]) => value > 0)
            .sort((a, b) => b[1] - a[1]); // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

        if (categoryEntries.length === 0) {
            console.log('âš ï¸ No data for category chart');
            return;
        }

        // shadcn ìŠ¤íƒ€ì¼ ìƒ‰ìƒ (ìë™ì°¨ ì‚¬ê³  ìœ í˜•ë³„ ìƒ‰ìƒ ë§µí•‘)
        const categoryColors = [
            '#8B5CF6',  // purple-500 - ì¶”ë½ì‚¬ê³ 
            '#06B6D4',  // cyan-500 - ê¸°ê³„ì‚¬ê³ 
            '#10B981',  // emerald-500 - í™”ì¬ì‚¬ê³ 
            '#F59E0B',  // amber-500 - êµí†µì‚¬ê³ 
            '#EF4444',  // red-500 - ê°ì „ì‚¬ê³ 
            '#6B7280',  // gray-500 - ì¤‘ë…ì‚¬ê³ 
            '#EC4899',  // pink-500 - ê¸°íƒ€
        ];

        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categoryEntries.map(([key, value]) => key),
                datasets: [{
                    data: categoryEntries.map(([key, value]) => value),
                    backgroundColor: categoryEntries.map((_, index) => categoryColors[index % categoryColors.length]),
                    borderWidth: 2,
                    borderColor: '#FFFFFF',
                    hoverBorderWidth: 3,
                    hoverBorderColor: '#F1F5F9'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '50%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 10,
                                weight: 500
                            },
                            padding: 12,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor,
                                            lineWidth: dataset.borderWidth,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        titleColor: '#F9FAFB',
                        bodyColor: '#F9FAFB',
                        borderColor: '#374151',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed}ê±´ (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    duration: 800
                }
            }
        });

        // ê°€ì¥ ë§ì€ ìœ í˜•ê³¼ ì´ ìœ í˜• ìˆ˜
        const mostCommon = categoryEntries[0];
        const totalCategories = categoryEntries.length;

        document.getElementById('category-summary').innerHTML = `
            <div class="space-y-1">
                <p class="text-xs"><strong>ì£¼ìš” ìœ í˜•:</strong> ${mostCommon[0]} (${mostCommon[1]}ê±´)</p>
                <p class="text-xs text-gray-600">ì´ ${totalCategories}ê°œ ì‚¬ê³  ìœ í˜• ë¶„ì„ë¨</p>
            </div>
        `;

        console.log('âœ… Category doughnut chart created successfully');
    } catch (error) {
        console.error('âŒ Error creating category chart:', error);
    }
}


function generateComprehensiveAnalysis(stats, totalResults) {
    try {
        // ì‹¤ì œ ìœ ë¦¬ë„ ê³„ì‚° (Test_casePedia ë°©ì‹)
        const favorableRate = ((stats.outcomes['ìœ ë¦¬'] || 0) / totalResults * 100).toFixed(1);
        const mainCategory = Object.entries(stats.categories).sort((a, b) => b[1] - a[1])[0][0];

        // í‰ê·  ìœ ì‚¬ë„ ê³„ì‚°
        const avgSimilarity = stats.similarities && stats.similarities.length > 0 ?
            (stats.similarities.reduce((a, b) => a + b, 0) / stats.similarities.length).toFixed(1) : '0';

        let analysis = `
            <div class="grid grid-cols-3 gap-2 mb-3">
                <div class="text-center p-2 bg-white rounded border">
                    <div class="text-lg font-bold text-green-600">${favorableRate}%</div>
                    <div class="text-xs text-gray-600">í‰ê·  ìœ ë¦¬ë„</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                    <div class="text-lg font-bold text-blue-600">${totalResults}</div>
                    <div class="text-xs text-gray-600">íŒë¡€ ìˆ˜</div>
                </div>
                <div class="text-center p-2 bg-white rounded border">
                    <div class="text-sm font-bold text-purple-600">${avgSimilarity}%</div>
                    <div class="text-xs text-gray-600">í‰ê·  ìœ ì‚¬ë„</div>
                </div>
            </div>
            <div class="space-y-1 text-xs">
                <p>ğŸ¯ <strong>ìœ ë¦¬ë„:</strong> ${favorableRate}% (${stats.outcomes['ìœ ë¦¬'] || 0}ê±´ ìœ ë¦¬í•œ ê²°ê³¼)</p>
                <p>ğŸ“‹ <strong>ì£¼ìš” ìœ í˜•:</strong> ${mainCategory} (${stats.categories[mainCategory]}ê±´)</p>
                <p>ğŸ“Š <strong>ìœ ì‚¬ë„:</strong> í‰ê·  ${avgSimilarity}% (Test_casePedia ë¶„ì„)</p>
                <p>ğŸ’¡ <strong>ì „ëµ:</strong> ${favorableRate >= 70 ? 'ìœ ë¦¬í•œ íŒë¡€ ë‹¤ìˆ˜' : favorableRate >= 50 ? 'ì‹ ì¤‘í•œ ì ‘ê·¼ í•„ìš”' : 'ì¶”ê°€ ì¦ê±° ìˆ˜ì§‘ ê¶Œì¥'}</p>
            </div>
        `;

        document.getElementById('comprehensive-analysis').innerHTML = analysis;
        console.log('âœ… Comprehensive analysis generated successfully');
    } catch (error) {
        console.error('âŒ Error generating comprehensive analysis:', error);
    }
}

function generateTop3Comparison(top3Results) {
    try {
        if (!top3Results || top3Results.length === 0) {
            document.getElementById('top3-comparison').innerHTML = '<p class="text-gray-500 text-xs">ë¹„êµí•  íŒë¡€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        console.log('ğŸ“‹ ìƒìœ„ 3ê°œ íŒë¡€ ë¹„êµ ìƒì„± ì¤‘:', top3Results);

        let comparisonHTML = `
            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left py-2 px-2 font-semibold text-gray-700 border-r">êµ¬ë¶„</th>
                            <th class="text-left py-2 px-2 font-semibold text-blue-700 border-r">1ìœ„ (ìµœê³  ìœ ì‚¬ë„)</th>
                            <th class="text-left py-2 px-2 font-semibold text-purple-700 border-r">2ìœ„</th>
                            <th class="text-left py-2 px-2 font-semibold text-green-700">3ìœ„</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
        `;

        // ìœ ì‚¬ë„ ë¹„êµ
        comparisonHTML += `
            <tr>
                <td class="py-2 px-2 font-medium text-gray-600 border-r bg-gray-50">ìœ ì‚¬ë„</td>
                ${top3Results.map((result, index) => {
                    const similarity = result.similarity_pct || (result.similarity * 100) || 0;
                    const color = index === 0 ? 'text-blue-600' : index === 1 ? 'text-purple-600' : 'text-green-600';
                    return `<td class="py-2 px-2 ${color} font-semibold ${index < 2 ? 'border-r' : ''}">${similarity.toFixed(1)}%</td>`;
                }).join('')}
            </tr>
        `;

        // ì‚¬ê³  ìœ í˜• ë¹„êµ
        comparisonHTML += `
            <tr>
                <td class="py-2 px-2 font-medium text-gray-600 border-r bg-gray-50">ì‚¬ê³ ìœ í˜•</td>
                ${top3Results.map((result, index) => {
                    const category = result.category || 'ê¸°íƒ€';
                    const categoryIcon = getCategoryIcon(category);
                    return `<td class="py-2 px-2 text-gray-700 ${index < 2 ? 'border-r' : ''}">${categoryIcon} ${category}</td>`;
                }).join('')}
            </tr>
        `;

        // ë²•ì› ë° ë‚ ì§œ
        comparisonHTML += `
            <tr>
                <td class="py-2 px-2 font-medium text-gray-600 border-r bg-gray-50">ë²•ì›</td>
                ${top3Results.map((result, index) => {
                    const court = result.court || 'ë¯¸ìƒ';
                    const shortCourt = court.length > 8 ? court.substring(0, 8) + '...' : court;
                    return `<td class="py-2 px-2 text-gray-700 ${index < 2 ? 'border-r' : ''}" title="${court}">${shortCourt}</td>`;
                }).join('')}
            </tr>
        `;

        comparisonHTML += `
            <tr>
                <td class="py-2 px-2 font-medium text-gray-600 border-r bg-gray-50">ì—°ë„</td>
                ${top3Results.map((result, index) => {
                    let year = 'ë¯¸ìƒ';

                    // 1ìˆœìœ„: accnum í•„ë“œ ì§ì ‘ ì‚¬ìš© (ì´ë¯¸ extract_year_from_textë¡œ ì¶”ì¶œëœ ì—°ë„)
                    if (result.accnum && result.accnum !== 'ë¯¸ìƒ') {
                        year = result.accnum;
                    }
                    // 2ìˆœìœ„: titleì—ì„œ ì§ì ‘ ì—°ë„ ì¶”ì¶œ
                    else if (result.title) {
                        const title = result.title;
                        // í•œêµ­ ë²•ì› ì‚¬ê±´ë²ˆí˜¸ íŒ¨í„´
                        const courtPatterns = [
                            /(\d{4})ê³ í•©/,  // 2018ê³ í•©123
                            /(\d{4})ê³ ë‹¨/,  // 2019ê³ ë‹¨456
                            /(\d{4})ë‚˜/,    // 2020ë‚˜789
                            /(\d{4})ë‹¤/,    // 2021ë‹¤123
                            /(\d{4})ëˆ„/,    // í–‰ì •ì†Œì†¡
                        ];

                        for (const pattern of courtPatterns) {
                            const match = title.match(pattern);
                            if (match && parseInt(match[1]) >= 1990 && parseInt(match[1]) <= 2030) {
                                year = match[1];
                                break;
                            }
                        }
                    }
                    // 3ìˆœìœ„: date í•„ë“œì—ì„œ ì—°ë„ ì¶”ì¶œ
                    if (year === 'ë¯¸ìƒ' && result.date) {
                        const dateMatch = result.date.match(/(\d{4})/);
                        if (dateMatch && parseInt(dateMatch[1]) >= 1990 && parseInt(dateMatch[1]) <= 2030) {
                            year = dateMatch[1];
                        }
                    }

                    return `<td class="py-2 px-2 text-gray-600 ${index < 2 ? 'border-r' : ''}">${year}</td>`;
                }).join('')}
            </tr>
        `;

        // ì˜ˆìƒ ê²°ê³¼ (ì œëª©ê³¼ ë‚´ìš©ì—ì„œ ì¶”ì¶œ)
        comparisonHTML += `
            <tr>
                <td class="py-2 px-2 font-medium text-gray-600 border-r bg-gray-50">ì˜ˆìƒê²°ê³¼</td>
                ${top3Results.map((result, index) => {
                    const outcome = predictOutcome(result);
                    const { text, color } = getOutcomeDisplay(outcome);
                    return `<td class="py-2 px-2 ${color} font-medium ${index < 2 ? 'border-r' : ''}">${text}</td>`;
                }).join('')}
            </tr>
        `;


        comparisonHTML += `
                    </tbody>
                </table>
            </div>
        `;

        // ìƒìœ„ íŒë¡€ ìš”ì•½ í…ìŠ¤íŠ¸ ì¶”ê°€
        comparisonHTML += `
            <div class="mt-3 pt-3 border-t border-gray-200">
                <p class="text-xs text-gray-600 font-medium mb-2">ğŸ“ í•µì‹¬ ì‹œì‚¬ì :</p>
                <div class="space-y-1">
                    ${top3Results.map((result, index) => {
                        const title = result.title || '';
                        const shortTitle = title.length > 30 ? title.substring(0, 30) + '...' : title;
                        const rankColor = index === 0 ? 'text-blue-600' : index === 1 ? 'text-purple-600' : 'text-green-600';
                        return `<p class="text-xs"><span class="${rankColor} font-semibold">${index + 1}ìœ„:</span> ${shortTitle}</p>`;
                    }).join('')}
                </div>
            </div>
        `;

        document.getElementById('top3-comparison').innerHTML = comparisonHTML;
        console.log('âœ… ìƒìœ„ 3ê°œ íŒë¡€ ë¹„êµí‘œ ìƒì„± ì™„ë£Œ');

    } catch (error) {
        console.error('âŒ ìƒìœ„ 3ê°œ íŒë¡€ ë¹„êµí‘œ ìƒì„± ì‹¤íŒ¨:', error);
        document.getElementById('top3-comparison').innerHTML = '<p class="text-red-500 text-xs">ë¹„êµí‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// í—¬í¼ í•¨ìˆ˜ë“¤
function getCategoryIcon(category) {
    const iconMap = {
        'ì¶”ë½ì‚¬ê³ ': 'ğŸªœ',
        'ê¸°ê³„ì‚¬ê³ ': 'âš™ï¸',
        'í™”ì¬ì‚¬ê³ ': 'ğŸ”¥',
        'êµí†µì‚¬ê³ ': 'ğŸš—',
        'ì¤‘ë…ì‚¬ê³ ': 'â˜£ï¸',
        'ê°ì „ì‚¬ê³ ': 'âš¡',
        'ì‚°ì—…ì¬í•´': 'âš ï¸'
    };
    return iconMap[category] || 'âš¡';
}

function predictOutcome(result) {
    const title = (result.title || '').toLowerCase();
    const content = (result.content || '').toLowerCase();

    console.log('ğŸ” Analyzing outcome for:', title.substring(0, 50), '...'); // ë””ë²„ê¹… ë¡œê·¸

    // Test_casePedia.ipynb ì›ë³¸ í‚¤ì›Œë“œ ì ìš©
    const favorableKeywords = [
        'ì²­êµ¬ì¸ìš©', 'ì›ê³ ìŠ¹ì†Œ', 'ì›ê³  ìŠ¹ì†Œ', 'ì¸ìš©í•œë‹¤', 'ì·¨ì†Œí•œë‹¤',
        'ì›ì²˜ë¶„ì„ ì·¨ì†Œ', 'ì²˜ë¶„ì„ ì·¨ì†Œ', 'í•­ì†Œë¥¼ ê¸°ê°', 'ìƒê³ ë¥¼ ê¸°ê°',
        'ì—…ë¬´ìƒ ì¬í•´ë¡œ ì¸ì •', 'ì—…ë¬´ìƒ ì§ˆë³‘ìœ¼ë¡œ ì¸ì •', 'ì—…ë¬´ìƒ ì‚¬ê³ ë¡œ ì¸ì •',
        'ìš”ì–‘ê¸‰ì—¬ë¥¼ ì§€ê¸‰', 'ì¥í•´ê¸‰ì—¬ë¥¼ ì§€ê¸‰', 'ìœ ì¡±ê¸‰ì—¬ë¥¼ ì§€ê¸‰'
    ];

    const unfavorableKeywords = [
        'ì²­êµ¬ê¸°ê°', 'ì²­êµ¬ë¥¼ ê¸°ê°', 'ì›ê³ íŒ¨ì†Œ', 'ì›ê³  íŒ¨ì†Œ', 'ê¸°ê°í•œë‹¤',
        'í•­ì†Œë¥¼ ì¸ìš©', 'ìƒê³ ë¥¼ ì¸ìš©', 'ì›ì‹¬ì„ íŒŒê¸°',
        'ì—…ë¬´ìƒ ì¬í•´ë¡œ ì¸ì •í•  ìˆ˜ ì—†', 'ì—…ë¬´ìƒ ì§ˆë³‘ìœ¼ë¡œ ë³¼ ìˆ˜ ì—†',
        'ìƒë‹¹ì¸ê³¼ê´€ê³„ê°€ ì—†', 'ìƒë‹¹ì¸ê³¼ê´€ê³„ë¥¼ ì¸ì •í•  ìˆ˜ ì—†',
        'ì—…ë¬´ì™€ ë¬´ê´€', 'ì‚¬ì  í–‰ìœ„', 'ê°œì¸ì  ì‚¬ì •',
        'ë¶ˆìŠ¹ì¸ ì²˜ë¶„ì€ ì ë²•', 'ë¶ˆì§€ê¸‰ ì²˜ë¶„ì€ ì •ë‹¹'
    ];

    // Test_casePedia.ipynb ì›ë³¸ ë¶„ì„ ë°©ì‹ êµ¬í˜„
    // 1. kinda ê°’(íŒê²°ê²°ê³¼) ì§ì ‘ í™œìš© (ê°€ì¥ ìš°ì„ ìˆœìœ„)
    const kinda = (result.kinda || '').toLowerCase();
    let kindaFavorable = 0;
    let kindaUnfavorable = 0;

    // íŒê²°ê²°ê³¼ë³„ ë¶„ë¥˜
    const favorableOutcomes = ['ì·¨ì†Œ', 'ì¸ìš©', 'ìŠ¹ì†Œ', 'ìŠ¹ì¸', 'ì§€ê¸‰'];
    const unfavorableOutcomes = ['ê¸°ê°', 'ê°í•˜', 'íŒ¨ì†Œ', 'ê±°ë¶€', 'ë¶ˆì¸ì •', 'ì·¨í•˜'];

    for (const outcome of favorableOutcomes) {
        if (kinda.includes(outcome)) {
            kindaFavorable += 5; // íŒê²°ê²°ê³¼ëŠ” ìµœê³  ê°€ì¤‘ì¹˜
            break;
        }
    }

    for (const outcome of unfavorableOutcomes) {
        if (kinda.includes(outcome)) {
            kindaUnfavorable += 5; // íŒê²°ê²°ê³¼ëŠ” ìµœê³  ê°€ì¤‘ì¹˜
            break;
        }
    }

    // 2. ë¬¸ì„œì˜ ë§ˆì§€ë§‰ 30% ë¶€ë¶„(ê²°ë¡ ) ì¶”ì¶œ
    const textLen = content.length;
    const conclusion = content.substring(Math.floor(textLen * 0.7)); // ë§ˆì§€ë§‰ 30%

    // 3. ê²°ë¡  ë¶€ë¶„ì—ì„œ í‚¤ì›Œë“œ ì¹´ìš´íŠ¸ (ê°€ì¤‘ì¹˜ 2ë°°)
    let favConclusion = 0;
    let unfConclusion = 0;

    for (const keyword of favorableKeywords) {
        const keywordLower = keyword.toLowerCase();
        if (conclusion.includes(keywordLower)) {
            favConclusion += 2; // ê²°ë¡  ë¶€ë¶„ ê°€ì¤‘ì¹˜
        }
    }

    for (const keyword of unfavorableKeywords) {
        const keywordLower = keyword.toLowerCase();
        if (conclusion.includes(keywordLower)) {
            unfConclusion += 2; // ê²°ë¡  ë¶€ë¶„ ê°€ì¤‘ì¹˜
        }
    }

    // 4. ì „ì²´ ë¬¸ì„œì—ì„œ í‚¤ì›Œë“œ ì¹´ìš´íŠ¸ (ê¸°ë³¸ ê°€ì¤‘ì¹˜ 1ë°°)
    let favTotal = 0;
    let unfTotal = 0;

    for (const keyword of favorableKeywords) {
        const keywordLower = keyword.toLowerCase();
        if (content.includes(keywordLower) || title.includes(keywordLower)) {
            favTotal += 1;
        }
    }

    for (const keyword of unfavorableKeywords) {
        const keywordLower = keyword.toLowerCase();
        if (content.includes(keywordLower) || title.includes(keywordLower)) {
            unfTotal += 1;
        }
    }

    // 5. í•©ì‚° ì ìˆ˜ ê³„ì‚° (kinda í¬í•¨)
    const favorableScore = kindaFavorable + favConclusion + favTotal;
    const unfavorableScore = kindaUnfavorable + unfConclusion + unfTotal;

    console.log(`ğŸ“Š Scores - Favorable: ${favorableScore} (kinda: ${kindaFavorable}, ê²°ë¡ : ${favConclusion}, ì „ì²´: ${favTotal})`);
    console.log(`ğŸ“Š Scores - Unfavorable: ${unfavorableScore} (kinda: ${kindaUnfavorable}, ê²°ë¡ : ${unfConclusion}, ì „ì²´: ${unfTotal})`);

    // Test_casePedia.ipynb ì›ë³¸ íŒì • ë¡œì§ ê·¸ëŒ€ë¡œ ì ìš© (2ê°€ì§€ ë¶„ë¥˜)
    if (favorableScore > unfavorableScore + 2) {
        console.log('âœ… ìœ ë¦¬ O: favorableì´ 2ì  ì´ìƒ ë†’ìŒ');
        return 'favorable';
    } else {
        console.log('âŒ ë¶ˆë¦¬ X: ê·¸ ì™¸ ëª¨ë“  ê²½ìš°');
        return 'unfavorable';
    }
}

function getOutcomeDisplay(outcome) {
    const outcomeMap = {
        'favorable': { text: 'âœ… ìœ ë¦¬', color: 'text-green-600' },
        'unfavorable': { text: 'âŒ ë¶ˆë¦¬', color: 'text-red-600' }
    };
    return outcomeMap[outcome] || { text: 'âŒ ë¶ˆë¦¬', color: 'text-red-600' };
}


// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ìœ ì‚¬ íŒë¡€ ê²€ìƒ‰ UI loaded');

    // ì´ˆê¸° ê²€ì¦ ì‹¤í–‰
    const queryInput = document.getElementById('simple_query');
    if (queryInput) {
        validateSearchQuery(queryInput.value);
    }

    // Chart.js ë¡œë”© ìƒíƒœ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
    setTimeout(() => {
        console.log('ğŸ” Chart.js ë””ë²„ê¹… ì •ë³´:');
        console.log('- typeof Chart:', typeof Chart);
        console.log('- Chart.version:', typeof Chart !== 'undefined' ? Chart.version : 'N/A');
        console.log('- window.chartJSFailed:', window.chartJSFailed);

        if (typeof Chart !== 'undefined') {
            console.log('âœ… Chart.js ì‚¬ìš© ê°€ëŠ¥ - ê³ í’ˆì§ˆ ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸ í™œì„±í™”');
        } else {
            console.log('âš ï¸ Chart.js ë¯¸ì‚¬ìš© - HTML/CSS fallback ì°¨íŠ¸ í™œì„±í™”');
        }

        // êµ¬í˜„ëœ ì‹œê°í™” ê¸°ëŠ¥ ì•ˆë‚´
        console.log('ğŸ“Š êµ¬í˜„ëœ ì‹œê°í™” ê¸°ëŠ¥:');
        console.log('1. ğŸ¯ ì¢…í•© ë¶„ì„ (ìœ ë¦¬ë„ %, ì£¼ìš” ìœ í˜•, í‰ê·  ìœ ì‚¬ë„)');
        console.log('2. ğŸ† ìƒìœ„ 3ê°œ íŒë¡€ ë¹„êµí‘œ (6ê°œ í•­ëª© ë¹„êµ)');
        console.log('3. ğŸ“Š ìœ ë¶ˆë¦¬ ë¶„ì„ ì°¨íŠ¸ (ìŠ¹ì†Œ/ì¸ì •/ê¸°ê°/í™”í•´ ë¹„ìœ¨)');
        console.log('4. ğŸ­ ì‚¬ê³ ìœ í˜• ë¶„í¬ ì°¨íŠ¸ (ì¶”ë½/ê¸°ê³„/í™”ì¬ ë“±)');
        console.log('ğŸ’¡ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ë©´ ìœ„ ì‹œê°í™”ë“¤ì´ ì‚¬ì´ë“œë°”ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤!');
    }, 500);

    // URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í™•ì¸ í›„ ìë™ ê²€ìƒ‰
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('query');

    if (queryParam) {
        document.getElementById('simple_query').value = queryParam;
        performSimpleSearch();
    }

    // Enter í‚¤ ê²€ìƒ‰ ì§€ì›
    document.getElementById('simple_query').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            performSimpleSearch();
        }
    });
});

// ========================
// ğŸ“„ ë ˆí¬íŠ¸ ìƒì„± ê´€ë ¨ í•¨ìˆ˜ë“¤
// ========================

// ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ ë° í†µê³„
let currentSearchData = {
    query: '',
    results: [],
    statistics: {},
    analysis: {}
};

async function generatePrecedentReport() {
    const button = document.getElementById('save-report-btn');
    const originalText = button.querySelector('span').textContent;

    try {
        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
        button.disabled = true;
        button.querySelector('span').textContent = 'ìƒì„± ì¤‘...';

        // ë°ì´í„° ê²€ì¦
        if (!currentSearchData.results || currentSearchData.results.length === 0) {
            throw new Error('ë ˆí¬íŠ¸ ìƒì„±ì„ ìœ„í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        console.log('ğŸ“„ PDF ë ˆí¬íŠ¸ ìƒì„± ì‹œì‘:', currentSearchData);

        // API í˜¸ì¶œ
        const response = await fetch('/analysis/api/generate-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(currentSearchData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // í…ìŠ¤íŠ¸ ë ˆí¬íŠ¸ ë‹¤ìš´ë¡œë“œ (ì•ˆì „í•˜ê³  í™•ì‹¤í•œ ë°©ì‹)
            if (result.text_data && result.filename) {
                downloadTextFromBase64(result.text_data, result.filename);
                console.log('âœ… í…ìŠ¤íŠ¸ ë ˆí¬íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', result.filename);
                console.log('ğŸ“Š íŒŒì¼ í¬ê¸°:', result.size, 'bytes');
                console.log('â±ï¸ ìƒì„± ì‹œê°„:', result.generation_time);
                console.log('ğŸ“„ í¬ë§·:', result.format);
            } else {
                throw new Error('ë ˆí¬íŠ¸ ë°ì´í„° ë˜ëŠ” íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤');
            }

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            showReportSuccessMessage(result);

        } else {
            throw new Error(result.error || 'ë ˆí¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }

    } catch (error) {
        console.error('âŒ ë ˆí¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        showReportErrorMessage(error.message);
    } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        button.disabled = false;
        button.querySelector('span').textContent = originalText;
    }
}

function downloadTextFromBase64(base64Data, filename) {
    try {
        // UTF-8 ì§€ì› Base64 ë””ì½”ë”© (í•œê¸€ ê¹¨ì§ ì™„ì „ ë°©ì§€)

        // 1. Base64 ë¬¸ìì—´ì„ ë°”ì´ë„ˆë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜
        const binaryString = atob(base64Data);

        // 2. ë°”ì´ë„ˆë¦¬ ë¬¸ìì—´ì„ Uint8Arrayë¡œ ë³€í™˜ (UTF-8 ë°”ì´íŠ¸ ë°°ì—´)
        const uint8Array = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            uint8Array[i] = binaryString.charCodeAt(i);
        }

        // 3. TextDecoderë¡œ UTF-8 ë””ì½”ë”© (í•œê¸€ ì™„ì „ ì§€ì›!)
        const textDecoder = new TextDecoder('utf-8');
        const textData = textDecoder.decode(uint8Array);

        // 4. UTF-8 BOM ì¶”ê°€ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
        const bom = '\uFEFF';
        const textWithBom = bom + textData;

        // 5. Blob ìƒì„± (í…ìŠ¤íŠ¸ íŒŒì¼)
        const blob = new Blob([textWithBom], {
            type: 'text/plain;charset=utf-8'
        });

        // 6. ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();

        // 7. ì •ë¦¬
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        console.log('ğŸ“¥ UTF-8 í…ìŠ¤íŠ¸ ë ˆí¬íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);

    } catch (error) {
        console.error('âŒ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        throw new Error('í…ìŠ¤íŠ¸ ë ˆí¬íŠ¸ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

function showReportSuccessMessage(result) {
    // ë©”ì‹œì§€ ë‚´ìš© êµ¬ì„±
    const filename = result.filename || 'report.txt';
    const totalPrecedents = result.report_info?.total_precedents || 0;
    const generationTime = result.generation_time || '0ì´ˆ';
    const fileSize = result.size ? Math.round(result.size / 1024) : 0;
    const format = result.format || 'text';

    // ì„ì‹œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    const message = document.createElement('div');
    message.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm';
    message.innerHTML = `
        <div class="flex items-start">
            <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <div class="flex-1 min-w-0">
                <strong>í…ìŠ¤íŠ¸ ë ˆí¬íŠ¸ ìƒì„± ì™„ë£Œ</strong>
                <div class="text-sm">${filename}</div>
                <div class="text-xs text-green-600">${totalPrecedents}ê±´ ë¶„ì„ Â· ${generationTime} Â· ${fileSize}KB</div>
                <div class="text-xs mt-1 text-green-600">ğŸ“„ í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ</div>
            </div>
        </div>
    `;

    document.body.appendChild(message);

    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (message.parentNode) {
            document.body.removeChild(message);
        }
    }, 3000);
}

function showReportErrorMessage(errorMessage) {
    // ì„ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
    const message = document.createElement('div');
    message.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50';
    message.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <strong>ë ˆí¬íŠ¸ ìƒì„± ì‹¤íŒ¨</strong>
                <div class="text-sm">${errorMessage}</div>
            </div>
        </div>
    `;

    document.body.appendChild(message);

    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (message.parentNode) {
            document.body.removeChild(message);
        }
    }, 5000);
}

function getCsrfToken() {
    // ì¿ í‚¤ì—ì„œ CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    const name = 'csrf_token=';
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');

    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return '';
}

function updateCurrentSearchData(data) {
    // í˜„ì¬ ê²€ìƒ‰ ë°ì´í„° ì—…ë°ì´íŠ¸
    currentSearchData = {
        query: data.query || '',
        results: data.results || [],
        statistics: {
            outcomes: data.outcomes || {},
            categories: data.categories || {},
            total_results: data.total_results || 0
        },
        analysis: data.analysis || {}
    };

    console.log('ğŸ“Š ê²€ìƒ‰ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ:', currentSearchData);
}

function updateReportButtonVisibility() {
    const button = document.getElementById('save-report-btn');
    if (currentSearchData.results && currentSearchData.results.length > 0) {
        button.classList.remove('hidden');
        button.disabled = false;
    } else {
        button.classList.add('hidden');
        button.disabled = true;
    }
}


// ============================================================================
// ğŸ”„ í”Œë¡œìš° ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
// ============================================================================

function goToDisabilityPrediction() {
    console.log('ğŸ”„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™: ì¥í•´ë“±ê¸‰ ì˜ˆì¸¡');
    window.location.href = '/analysis/disability';
}

function goToCompensationCalculator() {
    console.log('ğŸ”„ ë°”ë¡œ ì´ë™: ë³´ìƒê¸ˆ ê³„ì‚°');
    window.location.href = '/compensation/calculate';
}

function showNextStepSection() {
    const nextStepSection = document.getElementById('next-step-section');
    if (nextStepSection) {
        nextStepSection.classList.remove('hidden');
        console.log('âœ… ë‹¤ìŒ ë‹¨ê³„ ì„¹ì…˜ í‘œì‹œ');
    }
}

// ============================================================================
// ğŸ” ì¤‘ë³µ ë””ë²„ê¹… ê¸°ëŠ¥ ì œê±° ì™„ë£Œ
// ============================================================================







</script>

<style>
/* ì¶”ê°€ ìŠ¤íƒ€ì¼ */
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* íŒë¡€ ê²€ìƒ‰ ê²°ê³¼ ê°€ë…ì„± ê°œì„  */
.precedent-content {
    line-height: 1.6;
    word-spacing: 0.05em;
    letter-spacing: 0.025em;
}

/* í…ìŠ¤íŠ¸ ì¤„ ì œí•œ */
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.precedent-card {
    transition: all 0.2s ease-in-out;
}

.precedent-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

/* ì…ë ¥ ê²€ì¦ ìŠ¤íƒ€ì¼ */
.validation-input {
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.validation-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    background-color: #fef2f2;
}

.validation-warning {
    border-color: #f59e0b !important;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
    background-color: #fffbeb;
}

.validation-success {
    border-color: #10b981 !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    background-color: #ecfdf5;
}

.validation-input:focus {
    outline: none !important;
}

/* ê²€ì¦ ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
#query-validation-message {
    transition: all 0.3s ease;
}

/* ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
button:disabled {
    opacity: 0.6;
    cursor: not-allowed !important;
}

/* ê²€ì¦ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
.text-red-700 {
    color: #b91c1c;
}

.text-green-700 {
    color: #15803d;
}

.text-amber-700 {
    color: #b45309;
}

/* ë°˜ì‘í˜• ê°œì„  */
@media (max-width: 768px) {
    #query-validation-examples ul {
        font-size: 11px;
    }
}
</style>

{% endblock %}