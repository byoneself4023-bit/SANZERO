{% extends "base.html" %}

{% block title %}ì‚°ì¬ ë³´ìƒê¸ˆ ê³„ì‚°ê¸° - SANZERO{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="mb-8">
        <nav class="text-sm breadcrumbs mb-4">
            <a href="/compensation" class="text-blue-600 hover:text-blue-800">ë³´ìƒê¸ˆ ì„œë¹„ìŠ¤</a>
            <span class="mx-2 text-gray-400">></span>
            <span class="text-gray-600">ë³´ìƒê¸ˆ ê³„ì‚°ê¸°</span>
        </nav>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ì‚°ì¬ ë³´ìƒê¸ˆ ê³„ì‚°ê¸°</h1>
        <p class="text-gray-600">2025ë…„ ê¸°ì¤€ ì •í™•í•œ ì‚°ì—…ì¬í•´ ë³´ìƒê¸ˆì„ ê³„ì‚°í•´ë³´ì„¸ìš”</p>
    </div>

    <!-- ê¸°ì¤€ ì •ë³´ ì•ˆë‚´ -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
        <div class="flex items-start">
            <svg class="h-5 w-5 text-blue-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-sm text-blue-800">
                <p><strong>2025ë…„ ê¸°ì¤€ ì ìš©:</strong> ìµœì €/ìµœê³  ë³´ìƒê¸°ì¤€ê¸ˆì•¡ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.</p>
                <p class="mt-1">ì¼ê¸‰ ìµœì € {{ "{:,}".format(standards.min_daily) }}ì› ~ ìµœê³  {{ "{:,}".format(standards.max_daily) }}ì›</p>
            </div>
        </div>
    </div>

    <!-- ê³„ì‚°ê¸° í¼ -->
    <form id="calculatorForm" hx-post="/compensation/calculate" hx-target="#calculationResult" hx-swap="innerHTML" hx-indicator="#loadingIndicator">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <!-- í†µìƒì„ê¸ˆ ê³„ì‚° ì„¹ì…˜ -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">í†µìƒì„ê¸ˆ ê³„ì‚°</h2>

            <!-- ê³„ì‚° ë°©ë²• ì„ íƒ -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">í†µìƒì„ê¸ˆ ì…ë ¥ ë°©ë²• ì„ íƒ</label>
                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="radio" name="wage_method" value="direct" class="form-radio text-blue-600" onchange="toggleWageMethod()">
                        <span class="ml-2 text-sm">ë°©ë²• 1: ì§ì ‘ ê³„ì‚°í•œ í†µìƒì„ê¸ˆ ì…ë ¥</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="wage_method" value="monthly" class="form-radio text-blue-600" checked onchange="toggleWageMethod()">
                        <span class="ml-2 text-sm">ë°©ë²• 2: ì›” í†µìƒì„ê¸ˆ í¬í•¨ ì„ê¸ˆì•¡ìœ¼ë¡œ ìë™ ê³„ì‚°</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="wage_method" value="skip" class="form-radio text-blue-600" onchange="toggleWageMethod()">
                        <span class="ml-2 text-sm">ë°©ë²• 3: í†µìƒì„ê¸ˆ ì…ë ¥ ê±´ë„ˆë›°ê¸° (0ìœ¼ë¡œ ì²˜ë¦¬)</span>
                    </label>
                </div>
            </div>

            <!-- í†µìƒì„ê¸ˆ ì…ë ¥ -->
            <div id="wageAmountSection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2" id="wageAmountLabel">ì›” í†µìƒì„ê¸ˆ (ì›)</label>
                <input type="text" name="wage_amount" id="wageAmount" class="form-input w-full"
                       placeholder="ì˜ˆ: 3,500,000" inputmode="numeric" pattern="[0-9,]*"
                       oninput="formatCurrency(this)" autocomplete="off">
                <p class="text-xs text-gray-500 mt-1" id="wageAmountHelp">ì›” í†µìƒì„ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>

            <!-- í† ìš”ì¼ ê·¼ë¬´ ìœ í˜• (ë°©ë²• 2 ì„ íƒ ì‹œë§Œ í‘œì‹œ) -->
            <div id="saturdaySection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">í† ìš”ì¼ ì²˜ë¦¬ ë°©ì‹</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="saturday_type" value="full_8h" class="form-radio text-blue-600">
                        <div class="ml-2">
                            <span class="text-sm font-medium">í† ìš”ì¼ ìœ ê¸‰ 8ì‹œê°„</span>
                            <span class="text-xs text-gray-500 block">ì›” 243ì‹œê°„ ê¸°ì¤€ ((40+8+8) Ã— 4.345ì£¼)</span>
                        </div>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="saturday_type" value="half_4h" class="form-radio text-blue-600">
                        <div class="ml-2">
                            <span class="text-sm font-medium">í† ìš”ì¼ ìœ ê¸‰ 4ì‹œê°„</span>
                            <span class="text-xs text-gray-500 block">ì›” 226ì‹œê°„ ê¸°ì¤€ ((40+4+8) Ã— 4.345ì£¼)</span>
                        </div>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="saturday_type" value="no_pay" class="form-radio text-blue-600" checked>
                        <div class="ml-2">
                            <span class="text-sm font-medium">í† ìš”ì¼ ë¬´ê¸‰</span>
                            <span class="text-xs text-gray-500 block">ì›” 209ì‹œê°„ ê¸°ì¤€ ((40+0+8) Ã— 4.345ì£¼)</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- ê³„ì‚° ì˜µì…˜ ì„¹ì…˜ -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ê³„ì‚° ì˜µì…˜</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- ê³„ì‚° ê¸°ì¤€ì¼ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì‚° ê¸°ì¤€ì¼</label>
                    <input type="date" name="calculation_date" id="calculationDate" class="form-input w-full"
                           min="2025-01-01" max="2025-12-31" required>
                    <p class="text-xs text-gray-500 mt-1">YYYY-MM-DD í˜•ì‹ (ì˜ˆ: 2025-10-28)</p>
                </div>

                <!-- ë¶€ìƒ ìœ í˜• (ë…¸ë¬´ì‚¬ ì¶”ì²œìš©) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¶€ìƒ ìœ í˜• (ì„ íƒì‚¬í•­)</label>
                    <select name="injury_type" class="form-select w-full">
                        <option value="ê¸°íƒ€">ì„ íƒí•˜ì§€ ì•ŠìŒ</option>
                        <optgroup label="ê·¼ê³¨ê²©ê³„ ì§ˆí™˜">
                            <option value="ë°œëª© ì—¼ì¢Œ">ë°œëª© ì—¼ì¢Œ</option>
                            <option value="ì†ëª© ë¶€ìƒ">ì†ëª© ë¶€ìƒ</option>
                            <option value="í—ˆë¦¬ ë¶€ìƒ">í—ˆë¦¬ ë¶€ìƒ</option>
                            <option value="ë¬´ë¦ ë¶€ìƒ">ë¬´ë¦ ë¶€ìƒ</option>
                            <option value="ì–´ê¹¨ ë¶€ìƒ">ì–´ê¹¨ ë¶€ìƒ</option>
                        </optgroup>
                        <optgroup label="ì ˆë‹¨ ë° ì™¸ìƒ">
                            <option value="ì†ê°€ë½ ì ˆë‹¨">ì†ê°€ë½ ì ˆë‹¨</option>
                            <option value="ë°œê°€ë½ ì ˆë‹¨">ë°œê°€ë½ ì ˆë‹¨</option>
                            <option value="íŒ” ì ˆë‹¨">íŒ” ì ˆë‹¨</option>
                            <option value="ë‹¤ë¦¬ ì ˆë‹¨">ë‹¤ë¦¬ ì ˆë‹¨</option>
                        </optgroup>
                        <optgroup label="í™”ìƒ">
                            <option value="í™”ìƒ">í™”ìƒ</option>
                            <option value="ì „ê¸° í™”ìƒ">ì „ê¸° í™”ìƒ</option>
                        </optgroup>
                        <optgroup label="í˜¸í¡ê¸° ì§ˆí™˜">
                            <option value="ì§„íì¦">ì§„íì¦</option>
                            <option value="íì§ˆí™˜">íì§ˆí™˜</option>
                            <option value="ì²œì‹">ì²œì‹</option>
                        </optgroup>
                        <optgroup label="ì²­ë ¥ ì†ì‹¤">
                            <option value="ì†ŒìŒì„± ë‚œì²­">ì†ŒìŒì„± ë‚œì²­</option>
                            <option value="ëŒë°œì„± ë‚œì²­">ëŒë°œì„± ë‚œì²­</option>
                        </optgroup>
                        <optgroup label="ì‹¬í˜ˆê´€ê³„ ì§ˆí™˜">
                            <option value="ê¸‰ì„± ì‹¬ê·¼ê²½ìƒ‰">ê¸‰ì„± ì‹¬ê·¼ê²½ìƒ‰</option>
                            <option value="ë‡Œì¶œí˜ˆ">ë‡Œì¶œí˜ˆ</option>
                            <option value="ë‡Œê²½ìƒ‰">ë‡Œê²½ìƒ‰</option>
                        </optgroup>
                        <optgroup label="ì •ì‹ ì  ì§ˆí™˜">
                            <option value="ìš°ìš¸ì¦">ìš°ìš¸ì¦</option>
                            <option value="PTSD">PTSD</option>
                            <option value="ì ì‘ì¥ì• ">ì ì‘ì¥ì• </option>
                        </optgroup>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">ì „ë¬¸ ë…¸ë¬´ì‚¬ ì¶”ì²œì„ ìœ„í•´ ì„ íƒí•˜ì„¸ìš”</p>
                </div>

                <!-- ì¥í•´ë“±ê¸‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¥í•´ë“±ê¸‰ (ì„ íƒì‚¬í•­)</label>
                    <select name="disability_grade" class="form-select w-full">
                        <option value="">ì„ íƒí•˜ì§€ ì•ŠìŒ</option>
                        <option value="1ê¸‰">1ê¸‰ (ì—°ê¸ˆ)</option>
                        <option value="2ê¸‰">2ê¸‰ (ì—°ê¸ˆ)</option>
                        <option value="3ê¸‰">3ê¸‰ (ì—°ê¸ˆ)</option>
                        <option value="4ê¸‰">4ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="5ê¸‰">5ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="6ê¸‰">6ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="7ê¸‰">7ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="8ê¸‰">8ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="9ê¸‰">9ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="10ê¸‰">10ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="11ê¸‰">11ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="12ê¸‰">12ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="13ê¸‰">13ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                        <option value="14ê¸‰">14ê¸‰ (ì¼ì‹œê¸ˆ)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">ì œ1ê¸‰, ìœ ì¡± 1ëª… ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°</p>
                </div>

                <!-- ìœ ì¡± ìˆ˜ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìœ ì¡± ìˆ˜</label>
                    <input type="number" name="survivors_count" class="form-input w-full"
                           value="1" min="1" max="10">
                    <p class="text-xs text-gray-500 mt-1">ìœ ì¡±ê¸‰ì—¬ ê³„ì‚°ìš© (ê¸°ë³¸ 47% + ê°€ì‚°)</p>
                </div>

                <!-- í•œë„ ì ìš© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë³´ìƒê¸°ì¤€ í•œë„ ì ìš©</label>
                    <label class="flex items-center">
                        <input type="checkbox" name="apply_limits" class="form-checkbox text-blue-600" checked>
                        <span class="ml-2 text-sm">ìµœì €/ìµœê³  ë³´ìƒê¸°ì¤€ê¸ˆì•¡ ì ìš©</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">2025ë…„ ê¸°ì¤€ ìë™ ì ìš© ê¶Œì¥</p>
                </div>
            </div>
        </div>

        <!-- ê³„ì‚° ë²„íŠ¼ -->
        <div class="text-center mb-8">
            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                <svg class="h-5 w-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                ë³´ìƒê¸ˆ ê³„ì‚°í•˜ê¸°
            </button>
            <div id="loadingIndicator" class="hidden mt-4">
                <div class="inline-flex items-center">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-blue-600">ê³„ì‚° ì¤‘...</span>
                </div>
            </div>
        </div>
    </form>

    <!-- ê³„ì‚° ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
    <div id="calculationResult" class="hidden">
        <!-- HTMXë¡œ ê²°ê³¼ê°€ ë¡œë“œë©ë‹ˆë‹¤ -->
    </div>

    <!-- ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ì„¹ì…˜ -->
    <div id="next-step-compensation" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
        <div class="text-center">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ’¡ ë³´ìƒê¸ˆ ê³„ì‚° ì™„ë£Œ!</h3>
            <p class="text-blue-700 mb-4">ê³„ì‚°ëœ ë³´ìƒê¸ˆì„ ë°”íƒ•ìœ¼ë¡œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
            <div class="flex justify-center">
                <button onclick="goToLawyerFromCompensation()"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-lg transition-all duration-200 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    ë…¸ë¬´ì‚¬ ìƒë‹´ë°›ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ê³„ì‚° ê³µì‹ ì•ˆë‚´ -->
    <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">ê³„ì‚° ê³µì‹ ì•ˆë‚´</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
            <div>
                <h4 class="font-medium text-gray-900 mb-2">í†µìƒì„ê¸ˆ ê³„ì‚°</h4>
                <ul class="space-y-1 text-gray-600">
                    <li>â€¢ ì‹œê°„ê¸‰ = ì›” í†µìƒì„ê¸ˆ Ã· ì›” ì†Œì •ê·¼ë¡œì‹œê°„</li>
                    <li>â€¢ ì¼ê¸‰ = ì‹œê°„ê¸‰ Ã— 8ì‹œê°„</li>
                    <li>â€¢ ì›” ì†Œì •ê·¼ë¡œì‹œê°„ì€ í† ìš”ì¼ ì²˜ë¦¬ ë°©ì‹ì— ë”°ë¼ ê²°ì •</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium text-gray-900 mb-2">ì£¼ìš” ë³´ìƒê¸ˆ</h4>
                <ul class="space-y-1 text-gray-600">
                    <li>â€¢ <strong>íœ´ì—…ê¸‰ì—¬:</strong> í‰ê· ì„ê¸ˆì˜ 70%</li>
                    <li>â€¢ <strong>ìƒë³‘ë³´ìƒì—°ê¸ˆ:</strong> ì œ1ê¸‰ ê¸°ì¤€ 329ì¼</li>
                    <li>â€¢ <strong>ì¥í•´ê¸‰ì—¬:</strong> ìµœì €/ìµœê³  ë³´ìƒê¸°ì¤€ ì ìš©</li>
                    <li>â€¢ <strong>ìœ ì¡±ê¸‰ì—¬:</strong> ê¸°ë³¸ 47% + ê°€ì‚°</li>
                    <li>â€¢ <strong>ì¥ë¡€ë¹„:</strong> í‰ê· ì„ê¸ˆ Ã— 120ì¼</li>
                </ul>
            </div>
        </div>

        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-800">
                <strong>ì£¼ì˜ì‚¬í•­:</strong> ê³„ì‚° ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ ì§€ê¸‰ì•¡ì€ ê°œë³„ ìƒí™©ê³¼ ì‹¬ì‚¬ ê²°ê³¼ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                ì •í™•í•œ ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” ì „ë¬¸ê°€ ìƒë‹´ì„ ë°›ìœ¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<script>
// í†µìƒì„ê¸ˆ ê³„ì‚° ë°©ë²• ë³€ê²½ ì²˜ë¦¬
function toggleWageMethod() {
    const wageMethod = document.querySelector('input[name="wage_method"]:checked').value;
    const wageAmountSection = document.getElementById('wageAmountSection');
    const saturdaySection = document.getElementById('saturdaySection');
    const wageAmountLabel = document.getElementById('wageAmountLabel');
    const wageAmountHelp = document.getElementById('wageAmountHelp');
    const wageAmountInput = document.getElementById('wageAmount');

    if (wageMethod === 'skip') {
        wageAmountSection.style.display = 'none';
        saturdaySection.style.display = 'none';
        wageAmountInput.value = 0;
        wageAmountInput.required = false;
    } else {
        wageAmountSection.style.display = 'block';
        wageAmountInput.required = true;

        if (wageMethod === 'direct') {
            wageAmountLabel.textContent = 'ì¼ê¸‰ í†µìƒì„ê¸ˆ (ì›)';
            wageAmountHelp.textContent = 'ì§ì ‘ ê³„ì‚°í•œ ì¼ê¸‰ í†µìƒì„ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”';
            wageAmountInput.placeholder = 'ì˜ˆ: 150000';
            saturdaySection.style.display = 'none';
        } else {
            wageAmountLabel.textContent = 'ì›” í†µìƒì„ê¸ˆ (ì›)';
            wageAmountHelp.textContent = 'ì›” í†µìƒì„ê¸ˆì„ ì…ë ¥í•˜ì„¸ìš”';
            wageAmountInput.placeholder = 'ì˜ˆ: 3500000';
            saturdaySection.style.display = 'block';
        }
    }
}

// ìˆ«ì ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€ (ê°œì„ ëœ ë²„ì „)
function formatCurrency(input) {
    // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±° (ì½¤ë§ˆ í¬í•¨)
    let value = input.value.replace(/[^0-9]/g, '');

    // ë¹ˆ ê°’ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    if (!value) {
        input.value = '';
        return;
    }

    // ìˆ«ìë¥¼ ì²œë‹¨ìœ„ ì½¤ë§ˆë¡œ í¬ë§·íŒ…
    const numberValue = parseInt(value);
    const formattedValue = numberValue.toLocaleString('ko-KR');

    input.value = formattedValue;
}

// í¼ ì œì¶œ ì „ ê²€ì¦ ë° ìˆ«ì í˜•ì‹ ì •ë¦¬
document.getElementById('calculatorForm').addEventListener('submit', function(e) {
    const wageAmountInput = document.getElementById('wageAmount');
    const wageMethod = document.querySelector('input[name="wage_method"]:checked').value;

    // í†µìƒì„ê¸ˆ ì…ë ¥ì´ í•„ìš”í•œ ê²½ìš° ê²€ì¦
    if (wageMethod !== 'skip') {
        if (!wageAmountInput.value || wageAmountInput.value.trim() === '') {
            e.preventDefault();
            alert('í†µìƒì„ê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            wageAmountInput.focus();
            return false;
        }

        // ì½¤ë§ˆ ì œê±° í›„ ìˆ«ì ê²€ì¦
        const cleanValue = wageAmountInput.value.replace(/,/g, '');
        const numericValue = parseInt(cleanValue);

        if (isNaN(numericValue) || numericValue <= 0) {
            e.preventDefault();
            alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            wageAmountInput.focus();
            return false;
        }

        if (numericValue > 10000000) {
            e.preventDefault();
            alert('ì…ë ¥ ê°€ëŠ¥í•œ ìµœëŒ€ ê¸ˆì•¡ì€ 10,000,000ì›ì…ë‹ˆë‹¤.');
            wageAmountInput.focus();
            return false;
        }

        // ì½¤ë§ˆ ì œê±°ëœ ê°’ìœ¼ë¡œ ì„¤ì •
        wageAmountInput.value = cleanValue;
    }
});

// ì¥í•´ë“±ê¸‰ ì˜ˆì¸¡ ê²°ê³¼ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
function handlePredictionParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const disabilityGrade = urlParams.get('disability_grade');
    const fromPrediction = urlParams.get('from_prediction');

    if (fromPrediction === 'true' && disabilityGrade) {
        console.log(`ğŸ¯ ì¥í•´ë“±ê¸‰ ì˜ˆì¸¡ ê²°ê³¼ë¡œë¶€í„° ë°›ì€ ë“±ê¸‰: ${disabilityGrade}ê¸‰`);

        // ì¥í•´ë“±ê¸‰ ì„ íƒë°•ìŠ¤ ì„¤ì •
        const gradeSelect = document.querySelector('select[name="disability_grade"]');
        if (gradeSelect) {
            gradeSelect.value = `${disabilityGrade}ê¸‰`;
            console.log(`âœ… ì¥í•´ë“±ê¸‰ ${disabilityGrade}ê¸‰ ìë™ ì„¤ì • ì™„ë£Œ`);

            // ì‹œê°ì  ê°•ì¡° íš¨ê³¼
            gradeSelect.classList.add('ring-2', 'ring-green-400', 'bg-green-50');
            setTimeout(() => {
                gradeSelect.classList.remove('ring-2', 'ring-green-400', 'bg-green-50');
            }, 2000);

            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
            showToast(`ì¥í•´ë“±ê¸‰ ì˜ˆì¸¡ ê²°ê³¼ ${disabilityGrade}ê¸‰ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ì˜ˆì¸¡ ì¶œì²˜ í‘œì‹œ
        const predictionInfo = document.createElement('div');
        predictionInfo.className = 'bg-green-50 border-l-4 border-green-400 p-4 mb-6';
        predictionInfo.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-800">
                        <strong>AI ì˜ˆì¸¡ ê²°ê³¼ ì—°ë™:</strong> ì¥í•´ë“±ê¸‰ ${disabilityGrade}ê¸‰ ì˜ˆì¸¡ ê²°ê³¼ê°€ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        `;

        // í˜ì´ì§€ í—¤ë” ì•„ë˜ì— ì •ë³´ ì‚½ì…
        const headerSection = document.querySelector('.container .mb-8');
        if (headerSection) {
            headerSection.parentNode.insertBefore(predictionInfo, headerSection.nextSibling);
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê³„ì‚° ê¸°ì¤€ì¼ ì„¤ì •
    const today = new Date();
    const dateString = today.getFullYear() + '-' +
                      String(today.getMonth() + 1).padStart(2, '0') + '-' +
                      String(today.getDate()).padStart(2, '0');
    document.getElementById('calculationDate').value = dateString;

    // í†µìƒì„ê¸ˆ ë°©ë²• ì´ˆê¸°í™”
    toggleWageMethod();

    // ì¥í•´ë“±ê¸‰ ì˜ˆì¸¡ ê²°ê³¼ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
    handlePredictionParameters();
});

// HTMX ì‘ë‹µ ì²˜ë¦¬
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.target.id === 'calculationResult') {
        if (evt.detail.xhr.status === 200) {
            document.getElementById('calculationResult').classList.remove('hidden');
            // ë‹¤ìŒ ë‹¨ê³„ ì„¹ì…˜ í‘œì‹œ
            showCompensationNextStep();
            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('calculationResult').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        } else {
            // ì—ëŸ¬ ì²˜ë¦¬
            try {
                const errorData = JSON.parse(evt.detail.xhr.responseText);
                showToast(errorData.error || 'ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } catch {
                showToast('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
    }
});

// í”Œë¡œìš° ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
function goToLawyerFromCompensation() {
    console.log('ğŸ”„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™: ë…¸ë¬´ì‚¬ ìƒë‹´');
    window.location.href = '/lawyers';
}

function goToPrecedentAnalysis() {
    console.log('ğŸ”„ ì´ë™: íŒë¡€ ë¶„ì„');
    window.location.href = '/analysis/precedent';
}

function showCompensationNextStep() {
    const nextStepSection = document.getElementById('next-step-compensation');
    if (nextStepSection) {
        nextStepSection.classList.remove('hidden');
        console.log('âœ… ë‹¤ìŒ ë‹¨ê³„ ì„¹ì…˜ í‘œì‹œ (ë³´ìƒê¸ˆ ê³„ì‚° ì™„ë£Œ)');
    }
}

// í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showToast(message, type = 'info') {
    // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
    const existingToast = document.getElementById('toast-notification');
    if (existingToast) {
        existingToast.remove();
    }

    // í† ìŠ¤íŠ¸ ìƒ‰ìƒ ì„¤ì •
    const colorClasses = {
        'success': 'bg-green-100 border-green-400 text-green-700',
        'error': 'bg-red-100 border-red-400 text-red-700',
        'info': 'bg-blue-100 border-blue-400 text-blue-700',
        'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700'
    };

    // í† ìŠ¤íŠ¸ ìƒì„±
    const toast = document.createElement('div');
    toast.id = 'toast-notification';
    toast.className = `fixed top-4 right-4 z-50 border border-l-4 p-4 rounded shadow-lg ${colorClasses[type] || colorClasses.info}`;
    toast.innerHTML = `
        <div class="flex items-center justify-between">
            <span class="text-sm font-medium">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg leading-none">&times;</button>
        </div>
    `;

    // í˜ì´ì§€ì— ì¶”ê°€
    document.body.appendChild(toast);

    // ìë™ ì œê±° (3ì´ˆ í›„)
    setTimeout(() => {
        if (toast && toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}
</script>

<style>
/* í¼ ìŠ¤íƒ€ì¼ë§ */
.form-input, .form-select {
    @apply border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
}

.form-radio, .form-checkbox {
    @apply text-blue-600 focus:ring-blue-500;
}

/* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .grid-cols-1 {
        grid-template-columns: 1fr;
    }

    .md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}