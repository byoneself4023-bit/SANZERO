{% extends "base.html" %}

{% block title %}분석 내역 - SANZERO{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- 페이지 헤더 -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="/" class="text-gray-500 hover:text-gray-700 mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">분석 내역</h1>
        </div>
        <p class="text-gray-600">
            AI 분석 요청 내역을 확인하고 결과를 다시 볼 수 있습니다.
        </p>
    </div>

    <!-- 필터 및 검색 -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center">
                <label for="statusFilter" class="text-sm font-medium text-gray-700 mr-2">상태:</label>
                <select
                    id="statusFilter"
                    onchange="filterByStatus(this.value)"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                >
                    <option value="">전체</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>완료</option>
                    <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>진행중</option>
                    <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>실패</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>대기</option>
                </select>
            </div>

            <div class="flex-1"></div>

            <a href="/analysis/precedent" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm">
                새 분석 요청
            </a>
        </div>
    </div>

    {% if analyses %}
    <!-- 분석 내역 목록 -->
    <div class="space-y-4">
        {% for analysis in analyses %}
        <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
            <div class="p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <h3 class="text-lg font-semibold text-gray-900 mr-3">
                                {% if analysis.analysis_type == 'precedent_search' %}
                                    판례 분석
                                {% elif analysis.analysis_type == 'disability_prediction' %}
                                    장해등급 예측
                                {% else %}
                                    {{ analysis.analysis_type }}
                                {% endif %}
                            </h3>
                            <span class="px-3 py-1 rounded-full text-xs font-medium
                                {% if analysis.status == 'completed' %}bg-green-100 text-green-800
                                {% elif analysis.status == 'processing' %}bg-yellow-100 text-yellow-800
                                {% elif analysis.status == 'failed' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if analysis.status == 'completed' %}✅ 완료
                                {% elif analysis.status == 'processing' %}⏳ 진행중
                                {% elif analysis.status == 'failed' %}❌ 실패
                                {% else %}⏸️ 대기{% endif %}
                            </span>
                        </div>

                        <p class="text-gray-700 mb-3">{{ analysis.query_text[:150] }}{% if analysis.query_text|length > 150 %}...{% endif %}</p>

                        <div class="flex items-center text-sm text-gray-500 space-x-4">
                            <span>{{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            {% if analysis.processing_time_ms %}
                            <span>처리시간: {{ "%.1f"|format(analysis.processing_time_ms / 1000) }}초</span>
                            {% endif %}
                            <span>ID: {{ analysis.id[:8] }}...</span>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2 ml-4">
                        {% if analysis.status == 'completed' %}
                        <a href="/analysis/results/{{ analysis.id }}"
                           class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm">
                            결과 보기
                        </a>
                        {% elif analysis.status == 'processing' %}
                        <a href="/analysis/results/{{ analysis.id }}"
                           class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors duration-200 text-sm">
                            진행 상황 보기
                        </a>
                        {% elif analysis.status == 'failed' %}
                        <button onclick="retryAnalysis('{{ analysis.id }}')"
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 text-sm">
                            다시 시도
                        </button>
                        {% endif %}

                        <button onclick="deleteAnalysis('{{ analysis.id }}')"
                                class="text-gray-400 hover:text-red-600 p-2"
                                title="삭제">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 진행중인 분석의 경우 진행률 표시 -->
                {% if analysis.status == 'processing' %}
                <div class="mt-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>분석 진행중...</span>
                        <span>예상 완료 시간: 2-5분</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 페이지네이션 (향후 구현) -->
    <div class="mt-8 flex justify-center">
        <div class="flex items-center space-x-2">
            <button class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" disabled>
                이전
            </button>
            <span class="px-3 py-2 text-sm text-white bg-blue-600 border border-blue-600 rounded-lg">
                1
            </span>
            <button class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" disabled>
                다음
            </button>
        </div>
    </div>

    {% else %}
    <!-- 분석 내역 없음 -->
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-12 text-center">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="text-xl font-medium text-gray-900 mb-2">분석 내역이 없습니다</h3>
        <p class="text-gray-600 mb-6">아직 AI 분석을 요청하지 않으셨습니다. 첫 번째 분석을 시작해보세요!</p>
        <a href="/analysis/precedent" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200">
            판례 분석 시작하기
        </a>
    </div>
    {% endif %}
</div>

<script>
// 상태별 필터링
function filterByStatus(status) {
    const url = new URL(window.location);
    if (status) {
        url.searchParams.set('status_filter', status);
    } else {
        url.searchParams.delete('status_filter');
    }
    window.location.href = url.toString();
}

// 분석 삭제
async function deleteAnalysis(analysisId) {
    if (!confirm('이 분석 요청을 삭제하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/analysis/api/analysis/${analysisId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrf_token')
            }
        });

        if (response.ok) {
            showToast('분석 요청이 삭제되었습니다.', 'success');
            location.reload();
        } else {
            throw new Error('삭제 실패');
        }
    } catch (error) {
        showToast('삭제 중 오류가 발생했습니다.', 'error');
    }
}

// 분석 재시도
async function retryAnalysis(analysisId) {
    if (!confirm('이 분석을 다시 시도하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/analysis/api/analysis/${analysisId}/retry`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrf_token')
            }
        });

        if (response.ok) {
            showToast('분석을 다시 시작했습니다.', 'success');
            location.reload();
        } else {
            throw new Error('재시도 실패');
        }
    } catch (error) {
        showToast('재시도 중 오류가 발생했습니다.', 'error');
    }
}

// 진행중인 분석들 자동 새로고침
const processingAnalyses = document.querySelectorAll('[data-status="processing"]');
if (processingAnalyses.length > 0) {
    setTimeout(() => {
        location.reload();
    }, 30000); // 30초마다 새로고침
}
</script>
{% endblock %}